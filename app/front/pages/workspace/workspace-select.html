<!--APICall í•¨ìˆ˜ê°€ ë°±ì´ë‘ ì—°ê²°í•´ì¤Œ! + ê°œë°œëª¨ë“œ ì¶”ê°€-->

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„ íƒ - WorkSpace</title>
    
    <!-- CSS íŒŒì¼ë“¤ ì„í¬íŠ¸ -->
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/workspace-select.css">
</head>
<body>
    <!-- ë°°ê²½ ì¥ì‹ -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>

    <div class="select-container">
        <!-- í—¤ë” -->
        <div class="header-section">
            <div class="logo">ğŸŒŠ</div>
            <h1 class="welcome-text">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„ íƒ</h1>
            <p class="subtitle">ì°¸ì—¬í•  ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ì„ íƒí•˜ê±°ë‚˜<br>ìƒˆë¡œìš´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ì–´ ë³´ì„¸ìš”</p>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ -->
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">ê¹€</div>
            <div class="user-details">
                <div class="user-name" id="user-name">ê¹€ê°œë°œ</div>
                <div class="user-email" id="user-email">kim@example.com</div>
            </div>
        </div>

        <!-- íƒ­ ì„¹ì…˜ -->
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('my-workspaces', event)">
                ë‚´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤
            </button>
            <button class="tab-button" onclick="switchTab('create-workspace', event)">
                ìƒˆë¡œ ë§Œë“¤ê¸°
            </button>
            <button class="tab-button" onclick="switchTab('join-workspace', event)">
                ì°¸ì—¬í•˜ê¸°
            </button>
        </div>

            <!-- ë‚´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ íƒ­ -->
            <div class="tab-content active" id="my-workspaces">
                <div class="workspace-list" id="workspace-list">
                    <!-- ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="button-group">
                    <button class="btn btn-primary" id="enter-workspace-btn" onclick="enterWorkspace()" disabled>
                        <span id="enter-btn-text">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì…ì¥</span>
                    </button>
                    <button class="btn btn-secondary" onclick="refreshWorkspaces()">
                        ğŸ”„ ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
            </div>

            <!-- ìƒˆ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± íƒ­ -->
            <div class="tab-content" id="create-workspace">
                <div class="create-form">
                    <div class="form-group">
                        <label class="form-label" for="workspace-name">
                            ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ <span style="color: #ef4444;">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="workspace-name" 
                            class="form-input" 
                            placeholder="ì˜ˆ: ìŠ¤íƒ€íŠ¸ì—…íŒ€, ê°œë°œë¶€ì„œ, í”„ë¡œì íŠ¸A"
                            maxlength="50"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="workspace-description">
                            ì„¤ëª… (ì„ íƒì‚¬í•­)
                        </label>
                        <input 
                            type="text" 
                            id="workspace-description" 
                            class="form-input" 
                            placeholder="ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"
                            maxlength="100"
                        >
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="createWorkspace(event)">
                        <div class="loading-spinner" id="create-spinner"></div>
                        <span id="create-btn-text">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë§Œë“¤ê¸°</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearCreateForm()">
                        ì´ˆê¸°í™”
                    </button>
                </div>
            </div>

            <!-- ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì°¸ì—¬ íƒ­ -->
            <div class="tab-content" id="join-workspace">
                <div class="invite-form">
                    <div style="text-align: center; margin-bottom: 32px;">
                        <div class="invite-icon">ğŸ”—</div>
                        <div class="invite-title">ì´ˆëŒ€ ì½”ë“œë¡œ ì°¸ì—¬</div>
                        <div class="invite-description">
                            íŒ€ì›ìœ¼ë¡œë¶€í„° ë°›ì€ ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•˜ì—¬<br>
                            ê¸°ì¡´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ì°¸ì—¬í•˜ì„¸ìš”
                        </div>
                    </div>
                    <!-- ì„¸ë¡œí˜• ì…ë ¥ í¼ìœ¼ë¡œ ìˆ˜ì • -->
                    <div class="form-group">
                        <label class="form-label" for="invite-code">
                            ì´ˆëŒ€ ì½”ë“œ <span style="color: #ef4444;">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="invite-code" 
                            class="form-input" 
                            placeholder="ì´ˆëŒ€ ì½”ë“œ ì…ë ¥ (ì˜ˆ: XYZ123)"
                            maxlength="20"
                            style="text-align: center; font-weight: bold; letter-spacing: 2px;"
                        >
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="role-name">
                            ì—­í•  <span style="color: #ef4444;">*</span>
                        </label>
                        <select id="role-name" class="form-input">
                            <option value="">ì—­í• ì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="ì‚¬ì›">ì‚¬ì›</option>
                            <option value="ëŒ€ë¦¬">ëŒ€ë¦¬</option>
                            <option value="ê³¼ì¥">ê³¼ì¥</option>
                            <option value="íŒ€ì¥">íŒ€ì¥</option>
                            <option value="ë¶€ì¥">ë¶€ì¥</option>
                            <option value="ì´ì‚¬">ì´ì‚¬</option>
                        </select>
                    </div>

                  
                <div class="button-group">
                    <button class="btn btn-primary" id="join-workspace-btn" onclick="joinWorkspace(event)" disabled>
                        <div class="loading-spinner" id="join-spinner"></div>
                        <span id="join-btn-text">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì°¸ì—¬</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearJoinForm()">
                        ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
// ============================
// JWT í† í° ë””ì½”ë”© í•¨ìˆ˜ë“¤
// ============================

// Base64 URL ë””ì½”ë”© í•¨ìˆ˜
function base64UrlDecode(str) {
    // Base64 URLì„ ì¼ë°˜ Base64ë¡œ ë³€í™˜
    str = str.replace(/-/g, '+').replace(/_/g, '/');
    
    // íŒ¨ë”© ì¶”ê°€
    while (str.length % 4) {
        str += '=';
    }
    
    try {
        // Base64 ë””ì½”ë”© í›„ UTF-8ë¡œ ë³€í™˜
        return decodeURIComponent(atob(str).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));
    } catch (error) {
        console.error('Base64 ë””ì½”ë”© ì˜¤ë¥˜:', error);
        return null;
    }
}

// JWT í† í°ì—ì„œ í˜ì´ë¡œë“œ ì¶”ì¶œ
function parseJWT(token) {
    try {
        const parts = token.split('.');
        if (parts.length !== 3) {
            throw new Error('ìœ íš¨í•˜ì§€ ì•Šì€ JWT í˜•ì‹');
        }
        
        const payload = base64UrlDecode(parts[1]);
        if (!payload) {
            throw new Error('í˜ì´ë¡œë“œ ë””ì½”ë”© ì‹¤íŒ¨');
        }
        
        return JSON.parse(payload);
    } catch (error) {
        console.error('JWT íŒŒì‹± ì˜¤ë¥˜:', error);
        return null;
    }
}

// JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
function getUserInfoFromJWT() {
    const token = localStorage.getItem('access_token');
    
    if (!token) {
        console.log('í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
        return null;
    }
    
    const payload = parseJWT(token);
    
    if (!payload) {
        console.error('JWT íŒŒì‹± ì‹¤íŒ¨');
        return null;
    }
    
    console.log('JWT í˜ì´ë¡œë“œ:', payload);
    
    // í† í° ë§Œë£Œ ì²´í¬
    if (payload.exp && Date.now() >= payload.exp * 1000) {
        console.error('í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        localStorage.removeItem('access_token');
        return null;
    }
    
    // ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
    return {
        id: payload.user_id,
        name: payload.user_name,
        username: payload.user_name,
        email: payload.user_email,
        exp: payload.exp
    };
}

// ============================
// API ì„¤ì •
// ============================
const API_BASE_URL = 'http://localhost:8000';

// ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
let selectedWorkspace = null;
let userWorkspaces = [];

// ============================
// ê³µí†µ API í˜¸ì¶œ í•¨ìˆ˜
// ============================
async function apiCall(endpoint, options = {}) {
    try {
        const token = localStorage.getItem('access_token');
        const defaultHeaders = {
            'Content-Type': 'application/json'
        };

        if (token) {
            defaultHeaders['Authorization'] = `Bearer ${token}`;
        }

        const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            headers: {
                ...defaultHeaders,
                ...options.headers
            },
            ...options
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }

        return await response.json();
    } catch (error) {
        console.error(`API í˜¸ì¶œ ì˜¤ë¥˜ (${endpoint}):`, error);
        throw error;
    }
}

const IS_DEV_MODE = false;

// ============================
// ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ
// ============================
document.addEventListener('DOMContentLoaded', function() {    
    loadUserInfo();
    loadUserWorkspaces();
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    setupEventListeners();
});

// ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
function setupEventListeners() {
    // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ì…ë ¥ ì‹¤ì‹œê°„ ê²€ì¦
    const workspaceNameInput = document.getElementById('workspace-name');
    if (workspaceNameInput) {
        workspaceNameInput.addEventListener('input', function() {
            const createBtn = document.querySelector('#create-workspace .btn-primary');
            if (createBtn) {
                createBtn.disabled = this.value.trim().length < 2;
            }
        });
    }

    // ì´ˆëŒ€ ì½”ë“œ ì…ë ¥ ì‹¤ì‹œê°„ ê²€ì¦
    const inviteCodeInput = document.getElementById('invite-code');
    if (inviteCodeInput) {
        inviteCodeInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
            validateJoinForm();
        });
    }

    // ì—­í•  ì„ íƒ ë³€ê²½
    const roleSelect = document.getElementById('role-name');
    if (roleSelect) {
        roleSelect.addEventListener('change', handleRoleChange);
    }

    // ì—”í„°í‚¤ ì²˜ë¦¬
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab && activeTab.id === 'create-workspace') {
                const name = document.getElementById('workspace-name').value.trim();
                if (name.length >= 2) createWorkspace();
            } else if (activeTab && activeTab.id === 'join-workspace') {
                const joinBtn = document.getElementById('join-workspace-btn');
                if (joinBtn && !joinBtn.disabled) joinWorkspace();
            }
        }
    });
}

// ìˆ˜ì •ëœ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ í•¨ìˆ˜ (JWT ë””ì½”ë”© ìš°ì„ )
async function loadUserInfo() {
    console.log('ğŸ‘¤ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹œì‘...');
    
    // 1. ë¨¼ì € JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ ì‹œë„
    const jwtUserInfo = getUserInfoFromJWT();
    
    if (jwtUserInfo) {
        console.log('âœ… JWTì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œë¨:', jwtUserInfo);
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('user-name').textContent = jwtUserInfo.name || jwtUserInfo.username;
        document.getElementById('user-email').textContent = jwtUserInfo.email;
        document.getElementById('user-avatar').textContent = (jwtUserInfo.name || jwtUserInfo.username).charAt(0);
        
        return;
    }
    
    // 2. JWTì—ì„œ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìœ¼ë©´ API í˜¸ì¶œ
    try {
        console.log('JWTì—ì„œ ì •ë³´ ì¶”ì¶œ ì‹¤íŒ¨, API í˜¸ì¶œ ì‹œë„...');
        const userData = await apiCall('/auth/me');
        console.log('âœ… APIì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œë¨:', userData);
        
        document.getElementById('user-name').textContent = userData.name || userData.username;
        document.getElementById('user-email').textContent = userData.email;
        document.getElementById('user-avatar').textContent = (userData.name || userData.username).charAt(0);
    } catch (error) {
        console.error('âŒ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        
        if (!IS_DEV_MODE && (error.message.includes('401') || error.message.includes('403'))) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login.html';
        }
    }
}

// ì‚¬ìš©ìì˜ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ë¡œë“œ
async function loadUserWorkspaces() {
    console.log('ğŸ“‹ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹œì‘...');
    
    try {
        const data = await apiCall('/workspaces/workspaces_list');
        console.log('API ì‘ë‹µ:', data);
        
        userWorkspaces = data.map((ws, index) => ({
            id: index + 1,
            name: ws.name,
            description: '',
            member_count: 1,
            role: ws.is_workspace_admin ? 'admin' : 'member',
            status: 'active',
            last_activity: 'ìµœê·¼ í™œë™',
            start_date: ws.start_date,
            role_id: ws.role_id
        }));
        
        console.log('ë³€í™˜ëœ ì›Œí¬ìŠ¤í˜ì´ìŠ¤:', userWorkspaces);
        renderWorkspaceList();
    } catch (error) {
        console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        
        userWorkspaces = [];
        renderWorkspaceList();
        
        alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
}

// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ë Œë”ë§
function renderWorkspaceList() {
    console.log('ğŸ¨ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ë Œë”ë§ ì‹œì‘...');
    console.log('ë Œë”ë§í•  ì›Œí¬ìŠ¤í˜ì´ìŠ¤:', userWorkspaces);
    
    const listContainer = document.getElementById('workspace-list');
    
    if (!listContainer) {
        console.error('âŒ workspace-list ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
    }
    
    if (userWorkspaces.length === 0) {
        console.log('ğŸ“­ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ê°€ ì—†ìŒ - ë¹ˆ ìƒíƒœ í‘œì‹œ');
        listContainer.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ¢</div>
                <div class="empty-title">ì•„ì§ ì°¸ì—¬í•œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="empty-description">
                    ìƒˆ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ë§Œë“¤ê±°ë‚˜<br>
                    ì´ˆëŒ€ ì½”ë“œë¡œ ê¸°ì¡´ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ì°¸ì—¬í•´ë³´ì„¸ìš”
                </div>
            </div>
        `;
        return;
    }

    console.log(`âœ… ${userWorkspaces.length}ê°œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë Œë”ë§ ì¤‘...`);
    
    listContainer.innerHTML = userWorkspaces.map(workspace => `
        <div class="workspace-item" onclick="selectWorkspace(${workspace.id}, event)" data-workspace-id="${workspace.id}">
            <div class="workspace-status status-${workspace.status || 'active'}">
                ${workspace.status === 'pending' ? 'ìŠ¹ì¸ ëŒ€ê¸°' : 'í™œì„±'}
            </div>
            <div class="workspace-header">
                <div class="workspace-icon">
                    ${getWorkspaceIcon(workspace.name)}
                </div>
                <div class="workspace-info">
                    <div class="workspace-name">${workspace.name}</div>
                    <div class="workspace-meta">
                        ğŸ‘¥ ${workspace.member_count || 0}ëª… â€¢ 
                        ${workspace.role === 'admin' ? 'ğŸ‘‘ ê´€ë¦¬ì' : 'ğŸ‘¤ ë©¤ë²„'} â€¢ 
                        ${workspace.last_activity || 'ìµœê·¼ í™œë™ ì—†ìŒ'}
                    </div>
                </div>
            </div>
            ${workspace.description ? `<div style="margin-top: 8px; color: #64748b; font-size: 14px;">${workspace.description}</div>` : ''}
        </div>
    `).join('');
    
    console.log('âœ… ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ëª©ë¡ ë Œë”ë§ ì™„ë£Œ');
}

// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì•„ì´ì½˜ ì¶”ì¶œ
function getWorkspaceIcon(name) {
    const match = name.match(/[\u{1F300}-\u{1F9FF}]/u);
    return match ? match[0] : 'ğŸ¢';
}

// ============================
// íƒ­ ì „í™˜
// ============================
function switchTab(tabName, event = null) {
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    
    if (event && event.target) {
        event.target.classList.add('active');
    } else {
        const buttons = document.querySelectorAll('.tab-button');
        buttons.forEach((btn, index) => {
            if ((tabName === 'my-workspaces' && index === 0) ||
                (tabName === 'create-workspace' && index === 1) ||
                (tabName === 'join-workspace' && index === 2)) {
                btn.classList.add('active');
            }
        });
    }

    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');

    if (tabName !== 'my-workspaces') {
        selectedWorkspace = null;
        updateEnterButton();
    }
}

// ============================
// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„ íƒ
// ============================
function selectWorkspace(workspaceId, event = null) {
    selectedWorkspace = userWorkspaces.find(ws => ws.id === workspaceId);
    
    document.querySelectorAll('.workspace-item').forEach(item => {
        item.classList.remove('selected');
    });
    
    if (event && event.target) {
        const workspaceItem = event.target.closest('.workspace-item');
        if (workspaceItem) {
            workspaceItem.classList.add('selected');
        }
    } else {
        const workspaceItem = document.querySelector(`[data-workspace-id="${workspaceId}"]`);
        if (workspaceItem) {
            workspaceItem.classList.add('selected');
        }
    }
    
    updateEnterButton();
}

function updateEnterButton() {
    const enterBtn = document.getElementById('enter-workspace-btn');
    const btnText = document.getElementById('enter-btn-text');
    
    if (selectedWorkspace) {
        enterBtn.disabled = false;
        if (selectedWorkspace.status === 'pending') {
            btnText.textContent = 'ìŠ¹ì¸ ëŒ€ê¸° ì¤‘';
            enterBtn.disabled = true;
        } else {
            btnText.textContent = `${selectedWorkspace.name} ì…ì¥`;
        }
    } else {
        enterBtn.disabled = true;
        btnText.textContent = 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì…ì¥';
    }
}

// ============================
// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì…ì¥
// ============================
async function enterWorkspace() {
    if (!selectedWorkspace) return;

    const enterBtn = document.getElementById('enter-workspace-btn');
    const btnText = document.getElementById('enter-btn-text');
    
    enterBtn.disabled = true;
    btnText.textContent = 'ì…ì¥ ì¤‘...';

    try {
        const data = await apiCall('/workspaces/workspaces_select', {
            method: 'POST',
            body: JSON.stringify({
                workspace_name: selectedWorkspace.name
            })
        });

        console.log('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„ íƒ ì‘ë‹µ:', data);

        localStorage.setItem('current_workspace_name', data.workspace_name || selectedWorkspace.name);
        localStorage.setItem('is_workspace_admin', data.is_workspace_admin || false);
        localStorage.setItem('user_role_id', selectedWorkspace.role_id || '');
        localStorage.setItem('workspace_start_date', selectedWorkspace.start_date || '');
        
        if (data.access_token) {
            localStorage.setItem('access_token', data.access_token);
        }

        alert(`ğŸ‰ ${data.message || selectedWorkspace.name + ' ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤!'}`);
        
        window.location.href = `workspace-main.html?workspace_name=${encodeURIComponent(selectedWorkspace.name)}`;

    } catch (error) {
        console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì…ì¥ ì‹¤íŒ¨:', error);
        alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì…ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        
        enterBtn.disabled = false;
        updateEnterButton();
    }
}

// ============================
// ìƒˆ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„±
// ============================
async function createWorkspace(event = null) {
    const name = document.getElementById('workspace-name').value.trim();
    const description = document.getElementById('workspace-description').value.trim();
    
    if (!name) {
        alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const createBtn = event && event.target ? event.target : document.querySelector('#create-workspace .btn-primary');
    const btnText = document.getElementById('create-btn-text');
    const spinner = document.getElementById('create-spinner');

    createBtn.disabled = true;
    btnText.textContent = 'ìƒì„± ì¤‘...';
    spinner.style.display = 'inline-block';

    try {
        const data = await apiCall('/workspaces/create', {
            method: 'POST',
            body: JSON.stringify({
                workspace_name: name,
                description: description
            })
        });

        console.log('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ì‘ë‹µ:', data);

        const successMessage = data.message || `"${data.workspace_name || name}" ì›Œí¬ìŠ¤í˜ì´ìŠ¤ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`;
        const startDate = data.start_date ? `\nì‹œì‘ì¼: ${data.start_date}` : '';
        
        alert(`ğŸ‰ ${successMessage}${startDate}\nê´€ë¦¬ìë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        
        await loadUserWorkspaces();
        switchTab('my-workspaces');
        clearCreateForm();

    } catch (error) {
        console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒì„± ì‹¤íŒ¨:', error);
        alert(`ìƒì„± ì‹¤íŒ¨: ${error.message}`);
    } finally {
        createBtn.disabled = false;
        btnText.textContent = 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë§Œë“¤ê¸°';
        spinner.style.display = 'none';
    }
}

function clearCreateForm() {
    document.getElementById('workspace-name').value = '';
    document.getElementById('workspace-description').value = '';
    
    // ë²„íŠ¼ ìƒíƒœë„ ë¦¬ì…‹
    const createBtn = document.querySelector('#create-workspace .btn-primary');
    if (createBtn) {
        createBtn.disabled = true;
    }
}

// ============================
// ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì°¸ì—¬
// ============================
async function joinWorkspace(event = null) {
    const inviteCode = document.getElementById('invite-code').value.trim();
    const roleName = document.getElementById('role-name').value.trim();
    
    if (!inviteCode) {
        alert('ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!roleName) {
        alert('ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }

    const joinBtn = event && event.target ? event.target : document.getElementById('join-workspace-btn');
    const btnText = document.getElementById('join-btn-text');
    const spinner = document.getElementById('join-spinner');

    joinBtn.disabled = true;
    btnText.textContent = 'ì°¸ì—¬ ì¤‘...';
    spinner.style.display = 'inline-block';

    try {
        const data = await apiCall('/workspaces/join-request', {
            method: 'POST',
            body: JSON.stringify({
                invite_code: inviteCode,
                role_name: roleName
            })
        });

        alert('ğŸ‰ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê°€ì… ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!\nê´€ë¦¬ìì˜ ìŠ¹ì¸ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.');
        
        await loadUserWorkspaces();
        switchTab('my-workspaces');
        clearJoinForm();

    } catch (error) {
        console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì°¸ì—¬ ì‹¤íŒ¨:', error);
        alert(`ì°¸ì—¬ ì‹¤íŒ¨: ${error.message}`);
    } finally {
        joinBtn.disabled = false;
        btnText.textContent = 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì°¸ì—¬';
        spinner.style.display = 'none';
    }
}

function clearJoinForm() {
    document.getElementById('invite-code').value = '';
    document.getElementById('role-name').value = '';
    
    const joinBtn = document.getElementById('join-workspace-btn');
    if (joinBtn) {
        joinBtn.disabled = true;
    }
}

// ============================
// ê¸°íƒ€ ê¸°ëŠ¥ë“¤
// ============================
async function refreshWorkspaces(event = null) {
    const btn = event && event.target ? event.target : document.querySelector('.btn-secondary');
    const originalText = btn.textContent;
    
    btn.disabled = true;
    btn.textContent = 'ğŸ”„ ìƒˆë¡œê³ ì¹¨ ì¤‘...';
    
    try {
        await loadUserWorkspaces();
    } catch (error) {
        console.error('ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
    } finally {
        setTimeout(() => {
            btn.disabled = false;
            btn.textContent = originalText;
        }, 1000);
    }
}

function handleRoleChange() {
    validateJoinForm();
}

function validateJoinForm() {
    const joinBtn = document.getElementById('join-workspace-btn');
    const inviteCode = document.getElementById('invite-code').value.trim();
    const roleName = document.getElementById('role-name').value.trim();
   
    const isValid = inviteCode.length >= 3 && roleName.length > 0; 
    if (joinBtn) {
        joinBtn.disabled = !isValid;
    }
}

// ê°œë°œì ë„êµ¬ìš© ë””ë²„ê¹…
window.debugWorkspace = {
    fillTestData: () => {
        document.getElementById('workspace-name').value = 'í…ŒìŠ¤íŠ¸ ì›Œí¬ìŠ¤í˜ì´ìŠ¤';
        document.getElementById('workspace-description').value = 'í…ŒìŠ¤íŠ¸ìš© ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì…ë‹ˆë‹¤';
        document.getElementById('invite-code').value = 'TEST123';
        document.getElementById('role-name').value = 'ì‚¬ì›';
        console.log('í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    },
    testAPI: async () => {
        try {
            const data = await apiCall('/workspaces/workspaces_list');
            console.log('API í…ŒìŠ¤íŠ¸ ì„±ê³µ:', data);
        } catch (error) {
            console.error('API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        }
    },
    clearData: () => {
        userWorkspaces = [];
        renderWorkspaceList();
        console.log('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
    },
    testJWT: () => {
        const userInfo = getUserInfoFromJWT();
        console.log('JWT í…ŒìŠ¤íŠ¸ ê²°ê³¼:', userInfo);
    }
};

console.log('ğŸ”§ ê°œë°œì ë„êµ¬ì—ì„œ debugWorkspace ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
console.log('ì˜ˆ: debugWorkspace.fillTestData(), debugWorkspace.testAPI(), debugWorkspace.testJWT()');
    </script>
       
</body>
</html>
