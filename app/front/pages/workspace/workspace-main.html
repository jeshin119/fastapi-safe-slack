<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›Œí¬ìŠ¤í˜ì´ìŠ¤ - WorkSpace</title>
    
    <!-- CSS íŒŒì¼ë“¤ ì„í¬íŠ¸ -->
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/workspace-main.css">
</head>
<body>
    <!-- íŒŒì¼ ì…ë ¥ (ìˆ¨ê¹€) -->
    <input type="file" id="file-input" multiple accept="*/*">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
        <div class="workspace-header">
            <div class="workspace-name" id="workspace-name">ğŸŒŠ ë¡œë”©ì¤‘...</div>
            <div class="workspace-info" id="workspace-info">íŒ€ í˜‘ì—… ê³µê°„</div>
        </div>
        
        <div class="channels-section">
            <div class="section-header">
                <div class="section-title">ì±„ë„</div>
                <button class="refresh-btn" onclick="refreshChannels()" title="ì±„ë„ ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
            </div>
            
            <!-- ì±„ë„ ëª©ë¡ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
            <div class="channel-list-container">
                <ul class="channel-list" id="channel-list">
                    <!-- ì±„ë„ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </ul>
            </div>
            
            <div class="add-channel-button">
                <button class="add-channel-btn" onclick="goToChannelAdd()">
                    â• ì±„ë„ ì¶”ê°€
                </button>
            </div>
        </div>

        <div class="user-section">
            <div class="section-title">íŒ€ì›</div>
            <!-- íŒ€ì› ëª©ë¡ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
            <div class="team-members-container">
                <div id="team-members-list">
                    <!-- íŒ€ì› ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-content">
        <header class="chat-header">
            <div class="header-left">
                <h1 id="current-channel-title"># ë¡œë”©ì¤‘...</h1>
                <p id="current-channel-description">ì±„ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
            </div>
            <div class="header-right">
                <span class="channel-badge public" id="channel-type-badge">ğŸŒ ê³µê°œ</span>
                <button class="admin-btn" id="workspace-admin-btn" onclick="goToAdminPage()" title="ê´€ë¦¬ì í˜ì´ì§€" style="display: none;">ğŸ‘‘ ê´€ë¦¬ì</button>
            </div>
        </header>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <nav class="content-tabs">
            <button class="tab-button active" data-tab="chat" onclick="switchTab('chat')">
                ğŸ’¬ ëŒ€í™”
                <span class="tab-count" id="message-count">0</span>
            </button>
            <button class="tab-button" data-tab="files" onclick="switchTab('files')">
                ğŸ“ íŒŒì¼
                <span class="tab-count" id="file-count">0</span>
            </button>

            <!-- âœ… ë‚˜ê°€ê¸° ë²„íŠ¼ ì¶”ê°€ -->
            <button class="tab-button leave-tab-button" onclick="leaveChannel()" title="ì±„ë„ ë‚˜ê°€ê¸°" style="margin-left:auto;">
                ğŸšª ë‚˜ê°€ê¸°
            </button>
        </nav>

        <!-- ì±„íŒ… íƒ­ (ê¸°ë³¸) -->
        <div class="tab-content active" id="chat-content">
            <div class="chat-content">
                <!-- ì±„íŒ… ë©”ì‹œì§€ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
                <div class="chat-messages-container">
                    <div class="chat-messages" id="chat-messages">
                        <!-- í™˜ì˜ ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <div class="message-input-container">
                    <textarea class="message-input" id="message-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1"></textarea>
                    <div class="input-toolbar">
                        <div class="input-actions">
                            <button class="input-btn" onclick="attachFile()" title="íŒŒì¼ ì²¨ë¶€">ğŸ“</button>
                            <button class="input-btn" onclick="addEmoji()" title="ì´ëª¨ì§€">ğŸ˜Š</button>
                            <button class="input-btn" onclick="mentionUser()" title="ë©˜ì…˜">@</button>
                            <button class="input-btn" onclick="voiceMessage()" title="ìŒì„± ë©”ì‹œì§€">ğŸ¤</button>
                        </div>
                        <button class="send-btn" id="send-btn" onclick="sendMessage()">ì „ì†¡</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- íŒŒì¼ íƒ­ -->
        <div class="tab-content" id="files-content">
            <div class="chat-content">
                <!-- íŒŒì¼ ëª©ë¡ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
                <div class="chat-messages-container">
                    <div class="chat-messages" id="files-messages">
                        <div class="files-header">
                            <button class="refresh-btn" onclick="refreshFiles()" title="íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨">
                                <span class="refresh-icon">ğŸ”„</span>
                                <span class="refresh-text">íŒŒì¼ëª©ë¡ ìƒˆë¡œê³ ì¹¨</span>
                            </button>
                        </div>
                        <div class="upload-area" id="upload-area" onclick="triggerFileUpload()">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-title">íŒŒì¼ ì—…ë¡œë“œ</div>
                            <div class="upload-description">
                                íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì—¬ ë†“ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”
                            </div>
                            <button class="upload-button">ğŸ“¤ íŒŒì¼ ì„ íƒ</button>
                        </div>

                        <!-- íŒŒì¼ ì—…ë¡œë“œ ì˜µì…˜ (ìˆ¨ê¹€) -->
                        <div class="upload-options" id="upload-options" style="display: none;">
                            <div class="options-title">ğŸ“‹ íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ ì„¤ì •</div>
                            
                            <div class="form-group">
                                <label class="form-label" for="min-role">ìµœì†Œ ì ‘ê·¼ ì§ê¸‰ (ì„ íƒ)</label>
                                <select class="form-select" id="min-role">
                                    <option value="">ëª¨ë“  ì§ê¸‰</option>
                                    <!-- ì—­í•  ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </select>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="valid-from">ì ‘ê·¼ ì‹œì‘ì¼ (ì„ íƒ)</label>
                                    <input type="date" class="form-input" id="valid-from">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="valid-to">ì ‘ê·¼ ì¢…ë£Œì¼ (ì„ íƒ)</label>
                                    <input type="date" class="form-input" id="valid-to">
                                </div>
                            </div>

                            

                            <button class="upload-button" id="upload-submit-btn" style="width: 100%; margin-top: 16px;">ğŸ“¤ ì„ íƒëœ íŒŒì¼ ì—…ë¡œë“œ</button>
                        </div>

                        <!-- íŒŒì¼ ëª©ë¡ì— ìŠ¤í¬ë¡¤ ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
                        <div class="files-list-container">
                            <div class="files-list-box">
                                <div id="files-list">
                                    <!-- í™˜ì˜ ë©”ì‹œì§€ì™€ íŒŒì¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="message-input-container">
                    <textarea class="message-input" id="file-input-text" placeholder="íŒŒì¼ ê´€ë ¨ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." rows="1" style="display: none;"></textarea>
                    <div class="input-toolbar">
                        <div class="input-actions">
                            <!-- íŒŒì¼ ì—…ë¡œë“œì™€ ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì œê±° -->
                        </div>
                        <button class="send-btn" id="file-send-btn" onclick="triggerFileUpload()" style="display: none;">ì—…ë¡œë“œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">â³</div>
            <h3 class="modal-title">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¡œë”© ì¤‘...</h3>
            <p class="modal-description">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>

    <!-- ìƒˆ ì±„ë„ í™˜ì˜ ëª¨ë‹¬ -->
    <div id="new-channel-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">ğŸ‰</div>
            <h3 class="modal-title">ìƒˆ ì±„ë„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!</h3>
            <p class="modal-description" id="new-channel-message">ì±„ë„ì´ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
            <button class="modal-button" onclick="closeNewChannelModal()">í™•ì¸</button>
        </div>
    </div>

    <script>
        // ì„œë²„ ì—°ê²° ì„¤ì •
        const API_BASE_URL = 'http://localhost:8000';
        const WEBSOCKET_BASE_URL = 'ws://localhost:8000/ws';
    
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        let globalData = {
            user: null,
            workspace: null,
            channels: [],
            currentChannel: null,
            messages: {},  
            files: {},     
            teamMembers: [],
            isLoadingOlderMessages: false
        };
        
        let currentChannelName = "null";
        let currentTab = 'chat';
        let websocket = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
    
        // API í˜¸ì¶œ í•¨ìˆ˜
        async function apiCall(endpoint, options = {}) {
            try {
                const token = localStorage.getItem('jwt_token') || localStorage.getItem('access_token');
                const defaultHeaders = {
                    'Content-Type': 'application/json'
                };
    
                if (token) {
                    defaultHeaders['Authorization'] = `Bearer ${token}`;
                }
    
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    },
                    ...options
                });
    
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    
                    // ì¸ì¦ ì˜¤ë¥˜ ì²˜ë¦¬
                    if (response.status === 401 || response.status === 403) {
                        handleAuthError();
                        return;
                    }
                    
                    throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
                }
    
                return await response.json();
            } catch (error) {
                console.error(`API í˜¸ì¶œ ì˜¤ë¥˜ (${endpoint}):`, error);
                
                // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    updateConnectionStatus('offline');
                }
                
                throw error;
            }
        }
    
        // ì¸ì¦ ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜
        function handleAuthError() {
            // ì›¹ì†Œì¼“ ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
            cleanupWebSocketOnNavigation();
            
            localStorage.removeItem('jwt_token');
            localStorage.removeItem('access_token');
            localStorage.removeItem('current_workspace_name');
            localStorage.removeItem('is_workspace_admin');
            alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/login.html';
        }
    
        // WebSocket ì—°ê²° ê´€ë¦¬ (chat.py ë°©ì‹ìœ¼ë¡œ ìˆ˜ì •)
        function connectWebSocket() {
            try {
                if (!currentChannelName || !globalData.workspace?.name) {
                    console.log('WebSocket ì—°ê²° ëŒ€ê¸°: ì±„ë„ì´ë‚˜ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ê°€ ì—†ìŒ');
                    return;
                }

                const token = localStorage.getItem('jwt_token') || localStorage.getItem('access_token');
                if (!token) {
                    console.error('WebSocket ì—°ê²°ì„ ìœ„í•œ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì´ë¯¸ ì—°ê²° ì¤‘ì´ê±°ë‚˜ ì—°ê²°ëœ ìƒíƒœì¸ì§€ í™•ì¸
                if (websocket && (websocket.readyState === WebSocket.CONNECTING || websocket.readyState === WebSocket.OPEN)) {
                    console.log('WebSocketì´ ì´ë¯¸ ì—°ê²° ì¤‘ì´ê±°ë‚˜ ì—°ê²°ëœ ìƒíƒœì…ë‹ˆë‹¤.');
                    return;
                }

                // ê¸°ì¡´ ì—°ê²°ì´ ìˆìœ¼ë©´ ì•ˆì „í•˜ê²Œ ë‹«ê¸°
                if (websocket) {
                    // ì—°ê²° ìƒíƒœ í™•ì¸ í›„ ì•ˆì „í•˜ê²Œ ë‹«ê¸°
                    if (websocket.readyState === WebSocket.OPEN || websocket.readyState === WebSocket.CONNECTING) {
                        try {
                            websocket.close(1000, 'Channel switch');
                            // ì—°ê²° í•´ì œ ì™„ë£Œ ëŒ€ê¸°
                            setTimeout(() => {
                                websocket = null;
                            }, 100);
                        } catch (e) {
                            console.log('ê¸°ì¡´ WebSocket ì—°ê²° ë‹«ê¸° ì‹¤íŒ¨:', e);
                            websocket = null;
                        }
                    } else {
                        websocket = null;
                    }
                }

                // ì ì‹œ ëŒ€ê¸° í›„ ìƒˆ ì—°ê²° ì‹œë„ (ì´ì „ ì—°ê²°ì´ ì™„ì „íˆ ë‹«í ì‹œê°„ í™•ë³´)
                setTimeout(() => {
                    // chat.py ë°©ì‹ìœ¼ë¡œ WebSocket URL êµ¬ì„±
                    const wsUrl = `${WEBSOCKET_BASE_URL}/${globalData.workspace.name}/${currentChannelName}?token=${token}`;
                    console.log('WebSocket ì—°ê²° ì‹œë„:', wsUrl);
                    
                    websocket = new WebSocket(wsUrl);
                    
                    websocket.onopen = function() {
                        console.log('âœ… WebSocket ì—°ê²°ë¨:', currentChannelName);
                        updateConnectionStatus('online');
                        reconnectAttempts = 0;
                    };
        
                    websocket.onmessage = function(event) {
                        const data = JSON.parse(event.data);
                        console.log('ğŸ“¨ WebSocket ë©”ì‹œì§€ ìˆ˜ì‹ :', data);
                        handleWebSocketMessage(data);
                    };
        
                    websocket.onclose = function(event) {
                        console.log('âŒ WebSocket ì—°ê²° ì¢…ë£Œ:', event.code, event.reason);
                        updateConnectionStatus('offline');
                        
                        // ì •ìƒì ì¸ ì¢…ë£Œê°€ ì•„ë‹Œ ê²½ìš°ì—ë§Œ ì¬ì—°ê²° ì‹œë„
                        if (event.code !== 1000) {
                            attemptReconnect();
                        }
                    };
        
                    websocket.onerror = function(error) {
                        console.error('âŒ WebSocket ì˜¤ë¥˜:', error);
                        updateConnectionStatus('offline');
                    };
                }, 300); // 300ms ëŒ€ê¸°ë¡œ ì¦ê°€

            } catch (error) {
                console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
                updateConnectionStatus('offline');
            }
        }
    
        function attemptReconnect() {
            if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS && currentChannelName && !websocket) {
                reconnectAttempts++;
                updateConnectionStatus('reconnecting');
                setTimeout(() => {
                    console.log(`ğŸ”„ ì¬ì—°ê²° ì‹œë„ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`);
                    connectWebSocket();
                }, 3000 * reconnectAttempts);
            } else if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                console.log('ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
                updateConnectionStatus('offline');
            }
        }
    
        function handleWebSocketMessage(data) {
            console.log('ğŸ”§ WebSocket ë©”ì‹œì§€ ì²˜ë¦¬:', data.type, data);
            
            switch (data.type) {
                case 'connection':
                    console.log('âœ… WebSocket ì—°ê²° í™•ì¸:', data.message);
                    break;
                    
                case 'message':
                case 'new_message':
                    // ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
                    if (!globalData.messages[currentChannelName]) {
                        globalData.messages[currentChannelName] = [];
                    }
                    
                    const newMessage = {
                        id: data.message_id,
                        content: data.content,
                        user_id: data.user_id,
                        user_name: data.user_name,
                        user_email: data.user_email || data.user_name,
                        message_type: data.message_type || 'text',
                        timestamp: data.timestamp,
                        created_at: data.timestamp
                    };
                    
                    globalData.messages[currentChannelName].push(newMessage);
                    renderMessages();
                    updateChannelContent();
                    break;
                    
                case 'message_history':
                    // ë©”ì‹œì§€ íˆìŠ¤í† ë¦¬ ìˆ˜ì‹  ì²˜ë¦¬
                    if (data.messages && data.messages.length > 0) {
                        // DynamoDBì—ì„œ ì´ë¯¸ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ì˜´ (ë§¨ ìœ„ê°€ ê°€ì¥ ì˜ˆì „ ë©”ì‹œì§€)
                        globalData.messages[currentChannelName] = data.messages.map(msg => ({
                            id: msg.message_id,
                            content: msg.content,
                            user_id: msg.user_id,
                            user_name: msg.user_name,
                            user_email: msg.user_name, // DynamoDBì—ëŠ” emailì´ ì—†ì„ ìˆ˜ ìˆìŒ
                            message_type: msg.message_type || 'text',
                            timestamp: msg.timestamp,
                            created_at: msg.timestamp
                        }));
                        renderMessages();
                        updateChannelContent();
                        setupScrollHandler(); // ìŠ¤í¬ë¡¤ í•¸ë“¤ëŸ¬ ì„¤ì •
                    }
                    break;
                    
                case 'older_messages':
                    // ë” ì´ì „ ë©”ì‹œì§€ ìˆ˜ì‹  ì²˜ë¦¬
                    if (data.messages && data.messages.length > 0) {
                        const messages = globalData.messages[currentChannelName] || [];
                        
                        // ê¸°ì¡´ ë©”ì‹œì§€ ì•ì— ìƒˆë¡œìš´ ë©”ì‹œì§€ë“¤ ì¶”ê°€
                        const newMessages = data.messages.map(msg => ({
                            id: msg.message_id,
                            content: msg.content,
                            user_id: msg.user_id,
                            user_name: msg.user_name,
                            user_email: msg.user_name,
                            message_type: msg.message_type || 'text',
                            timestamp: msg.timestamp,
                            created_at: msg.timestamp
                        }));
                        
                        globalData.messages[currentChannelName] = [...newMessages, ...messages];
                        
                        // ë¡œë”© í‘œì‹œ ì œê±°
                        const loadingDiv = document.querySelector('.loading-older-messages');
                        if (loadingDiv) {
                            loadingDiv.remove();
                        }
                        
                        // ë¡œë”© ìƒíƒœ ë¦¬ì…‹
                        globalData.isLoadingOlderMessages = false;
                        
                        renderMessages();
                        updateChannelContent();
                    }
                    break;
                    
                case 'no_older_messages':
                    // ë” ì´ìƒ ì´ì „ ë©”ì‹œì§€ê°€ ì—†ìŒ
                    // const loadingDiv = document.querySelector('.loading-older-messages');
                    // if (loadingDiv) {
                    //     loadingDiv.innerHTML = '<span>ë” ì´ìƒ ì´ì „ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                    //     setTimeout(() => {
                    //         loadingDiv.remove();
                    //     }, 2000);
                    // }
                    // ë¡œë”© ìƒíƒœ ë¦¬ì…‹
                    globalData.isLoadingOlderMessages = false;
                    break;
                    
                case 'user_joined':
                    console.log('ğŸ‘‹ ì‚¬ìš©ì ì…ì¥:', data.user_name);
                    break;
                    
                case 'user_left':
                    console.log('ğŸ‘‹ ì‚¬ìš©ì í‡´ì¥:', data.user_name);
                    break;
                    
                case 'typing':
                    console.log('âŒ¨ï¸ íƒ€ì´í•‘ ìƒíƒœ:', data.user_name);
                    break;
                    
                case 'connected_users':
                    console.log('ğŸ‘¥ ì—°ê²°ëœ ì‚¬ìš©ì:', data.connected_users);
                    break;
                    
                case 'error':
                    console.error('âŒ WebSocket ì—ëŸ¬:', data.message);
                    alert('ì±„íŒ… ì˜¤ë¥˜: ' + data.message);
                    break;
                    
                default:
                    console.log('â“ ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', data.type, data);
            }
        }
    
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(status) {
            // ì—°ê²° ìƒíƒœ í‘œì‹œ ìš”ì†Œê°€ ìˆë‹¤ë©´ ì—…ë°ì´íŠ¸
            const statusElement = document.getElementById('connection-status');
            const statusText = document.querySelector('.status-text');
            
            if (statusElement) {
                statusElement.className = `connection-status ${status}`;
            }
            
            if (statusText) {
                switch (status) {
                    case 'online':
                        statusText.textContent = 'ì˜¨ë¼ì¸';
                        break;
                    case 'offline':
                        statusText.textContent = 'ì˜¤í”„ë¼ì¸';
                        break;
                    case 'reconnecting':
                        statusText.textContent = 'ì¬ì—°ê²° ì¤‘...';
                        break;
                }
            }
        }
    
        // JWT í† í°ì—ì„œ ì‚¬ìš©ì ì •ë³´ ì¶”ì¶œ
        function getUserInfoFromToken() {
            const token = localStorage.getItem('jwt_token') || localStorage.getItem('access_token');
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                // ì›¹ì†Œì¼“ ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
                cleanupWebSocketOnNavigation();
                window.location.href = '/login.html';
                return null;
            }
    
            try {
                // JWT í† í° íŒŒì‹±
                const payload = JSON.parse(atob(token.split('.')[1]));
                
                // í† í° ë§Œë£Œ ì²´í¬
                if (payload.exp && Date.now() >= payload.exp * 1000) {
                    console.error('í† í°ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    handleAuthError();
                    return null;
                }
    
                // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì˜ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ì™€ JWT ì •ë³´ ê²°í•©
                const workspaceName = localStorage.getItem('current_workspace_name') || payload.workspace_name;
                const isAdmin = localStorage.getItem('is_workspace_admin') === 'true' || payload.is_workspace_admin;
    
                return {
                    user_id: payload.user_id,
                    user_email: payload.user_email,
                    user_name: payload.user_name,
                    workspace_id: payload.workspace_id,
                    workspace_name: workspaceName,
                    role_id: payload.role_id,
                    role_name: payload.role_name || 'ë©¤ë²„',
                    is_workspace_admin: isAdmin,
                    is_contractor: payload.is_contractor || false
                };
            } catch (error) {
                console.error('í† í° íŒŒì‹± ì‹¤íŒ¨:', error);
                handleAuthError();
                return null;
            }
        }
    
        // ì´ˆê¸° ë°ì´í„° ë¡œë”©
        async function initializeWorkspace() {
            try {
                document.getElementById('loading-overlay').style.display = 'flex';
                
                const userInfo = getUserInfoFromToken();
                if (!userInfo) return;
                
                globalData.user = userInfo;
                globalData.workspace = {
                    name: userInfo.workspace_name,
                    id: userInfo.workspace_id
                };
    
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('workspace-name').textContent = `ğŸŒŠ ${userInfo.workspace_name}`;
                document.getElementById('workspace-info').textContent = `${userInfo.role_name} â€¢ ${userInfo.is_workspace_admin ? 'ê´€ë¦¬ì' : 'ë©¤ë²„'}`;
    
                // ê´€ë¦¬ìì¸ ê²½ìš°ë§Œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„¤ì • ë²„íŠ¼ í‘œì‹œ
                if (userInfo.is_workspace_admin) {
                    document.getElementById('workspace-admin-btn').style.display = 'block';
                }
    
                // URL íŒŒë¼ë¯¸í„° ì •ë¦¬
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('from_select')) {
                    urlParams.delete('from_select');
                    const newUrl = urlParams.toString() ? 
                        `${window.location.pathname}?${urlParams.toString()}` : 
                        window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                }
    
                // ë³‘ë ¬ë¡œ ë°ì´í„° ë¡œë”©
                await Promise.all([
                    loadChannels(),
                    loadTeamMembers()
                ]);
                
                const defaultChannel = globalData.channels.find(ch => ch.is_default) || globalData.channels[0];
                if (defaultChannel) {
                    await switchChannel(defaultChannel.name);
                }
    
            } catch (error) {
                console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                // ì›¹ì†Œì¼“ ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
                cleanupWebSocketOnNavigation();
                alert('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„ íƒ í˜ì´ì§€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.');
                window.location.href = '/workspace-select.html';
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }
    
        // ê´€ë¦¬ì í˜ì´ì§€ ì´ë™
        function goToAdminPage() {
            if (!globalData.user?.is_workspace_admin) {
                alert('ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }
            
            // ì›¹ì†Œì¼“ ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
            cleanupWebSocketOnNavigation();
            
            window.location.href = `/static/pages/admin/admin-main.html?workspace_name=${encodeURIComponent(globalData.workspace.name)}`;
        }

        // ì±„ë„ ì¶”ê°€ í˜ì´ì§€ ì´ë™
        function goToChannelAdd() {
            // ì›¹ì†Œì¼“ ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
            cleanupWebSocketOnNavigation();
            
            window.location.href = 'channel-add.html';
        }
    
        // ì±„ë„ ëª©ë¡ ë¡œë”©
        async function loadChannels() {
    try {
        const workspaceName = globalData.workspace?.name;
        if (!workspaceName) {
            console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        console.log('ğŸ” ì±„ë„ ë¡œë”© ì‹œì‘ - ì›Œí¬ìŠ¤í˜ì´ìŠ¤:', workspaceName);

        // POST /channels/listë¡œ API í˜¸ì¶œ
        const channels = await apiCall('/channels/list', {
            method: 'POST',
            body: JSON.stringify({
                workspace_name: workspaceName
            })
        });

        console.log('ğŸ“‹ ì±„ë„ ëª©ë¡ ì‘ë‹µ:', channels);
        console.log('ğŸ“‹ ì‘ë‹µ íƒ€ì…:', typeof channels);
        console.log('ğŸ“‹ ë°°ì—´ ì—¬ë¶€:', Array.isArray(channels));

        // ì‘ë‹µì´ ë°°ì—´ì¸ì§€ í™•ì¸í•˜ê³  ì²˜ë¦¬
        let channelArray = [];
        if (Array.isArray(channels)) {
            channelArray = channels;
            console.log('âœ… ì§ì ‘ ë°°ì—´ ì²˜ë¦¬ - ì±„ë„ ê°œìˆ˜:', channelArray.length);
        } else if (channels && channels.channels && Array.isArray(channels.channels)) {
            channelArray = channels.channels;
            console.log('âœ… channels ì†ì„± ì²˜ë¦¬ - ì±„ë„ ê°œìˆ˜:', channelArray.length);
        } else {
            console.error('âŒ ì˜ˆìƒí•˜ì§€ ëª»í•œ ì‘ë‹µ êµ¬ì¡°:', channels);
            channelArray = [];
        }

        // ê° ì±„ë„ ë°ì´í„° ë¡œê·¸ ì¶œë ¥
        channelArray.forEach((channel, index) => {
            console.log(`ğŸ“‹ ì±„ë„ ${index + 1}:`, channel);
        });

        // ì±„ë„ ë°ì´í„° ë³€í™˜
        globalData.channels = channelArray.map(channel => {
            const transformedChannel = {
                id: channel.channel_id || channel.id,
                name: channel.name || channel.channel_name,
                is_public: channel.is_public !== false, // ê¸°ë³¸ê°’ì„ trueë¡œ
                is_default: channel.is_default === true  // ë˜ëŠ” ê·¸ëƒ¥ channel.is_default
            };
            console.log('ğŸ”„ ì±„ë„ ë³€í™˜:', channel, 'â†’', transformedChannel);
            return transformedChannel;
        });

        console.log('âœ… ìµœì¢… ë³€í™˜ëœ ì±„ë„ ëª©ë¡:', globalData.channels);
        console.log('âœ… ìµœì¢… ì±„ë„ ê°œìˆ˜:', globalData.channels.length);

        // ì±„ë„ì´ ì—†ëŠ” ê²½ìš° ê²½ê³ 
        if (globalData.channels.length === 0) {
            console.warn('âš ï¸ ë³€í™˜ëœ ì±„ë„ì´ ì—†ìŠµë‹ˆë‹¤.');
        }

        renderChannelList();
        
    } catch (error) {
        console.error('âŒ ì±„ë„ ë¡œë”© ì‹¤íŒ¨:', error);
        console.error('âŒ ì—ëŸ¬ ìƒì„¸:', error.message);
        console.error('âŒ ì—ëŸ¬ ìŠ¤íƒ:', error.stack);
        
        // ì—ëŸ¬ ë°œìƒ ì‹œì—ë§Œ ë¹ˆ ë°°ì—´ë¡œ ì„¤ì •
        globalData.channels = [];
        renderChannelList();
        
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
        alert('ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    }
}
        
        // íŒ€ì› ëª©ë¡ ë¡œë”© (ì‹¤ì œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë©¤ë²„ API ì‚¬ìš©)
        async function loadTeamMembers() {
            try {
                const workspaceName = globalData.workspace?.name;
                
                if (!workspaceName) {
                    console.log('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ ì—†ìŒ');
                    globalData.teamMembers = [];
                    renderTeamMembers();
                    return;
                }

                // POST /workspaces/membersë¡œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë©¤ë²„ ì¡°íšŒ
                const members = await apiCall('/workspaces/members', {
                    method: 'POST',
                    body: JSON.stringify({
                        workspace_name: workspaceName
                    })
                });
                
                // ì‘ë‹µ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ë³€í™˜
                globalData.teamMembers = members.map(member => ({
                    user_id: member.user_id,
                    user_email: member.email,
                    user_name: member.name,
                    role_name: member.role_name,
                    is_admin: true 
                }));
                        
                renderTeamMembers();
            } catch (error) {
                console.error('íŒ€ì› ë¡œë”© ì‹¤íŒ¨:', error);
                globalData.teamMembers = [];
                renderTeamMembers();
            }
        }
    
        // ì±„ë„ ëª©ë¡ ë Œë”ë§
        function renderChannelList() {
            const channelList = document.getElementById('channel-list');
            
            channelList.innerHTML = globalData.channels.map(channel => {
                const isActive = channel.name === currentChannelName ? 'active' : '';
                const visibilityIcon = channel.is_public ? '#' : 'ğŸ”’';
                const messageCount = globalData.messages[channel.name]?.length || 0;
                
                return `
                    <li class="channel-item ${isActive}" data-channel-name="${channel.name}" onclick="switchChannel('${channel.name}')">
                        <span class="channel-icon">${visibilityIcon}</span>
                        <span class="channel-name">${channel.name}</span>
                        ${messageCount > 0 ? `<span class="message-count">${messageCount}</span>` : ''}
                    </li>
                `;
            }).join('');
        }
    
        // íŒ€ì› ëª©ë¡ ë Œë”ë§
        function renderTeamMembers() {
            const container = document.getElementById('team-members-list');
            const members = globalData.teamMembers || [];
            
            container.innerHTML = members.map(member => `
                <div class="team-member-item">
                    <div class="member-status ${member.is_online ? 'online' : 'offline'}"></div>
                    <span class="member-name">${member.user_email.split('@')[0]}</span>
                    <span class="member-role">${member.role_name}</span>
                </div>
            `).join('');
        }
    
        // ì±„ë„ ìƒˆë¡œê³ ì¹¨
        async function refreshChannels() {
            await loadChannels();
            if (currentChannelName) {
                await loadChannelData(currentChannelName);
                updateChannelContent();
            }
        }

        // ì±„ë„ ë‚˜ê°€ê¸°
        async function leaveChannel() {
            const workspaceName = localStorage.getItem("current_workspace_name");
            const channelName = localStorage.getItem("current_channel_name");

            if (!workspaceName || !channelName) {
                alert("ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë˜ëŠ” ì±„ë„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const confirmLeave = confirm(`ì •ë§ '${channelName}' ì±„ë„ì—ì„œ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?`);
            if (!confirmLeave) return;

            try {
                const token = localStorage.getItem('jwt_token') || localStorage.getItem('access_token');

                const response = await fetch(`${API_BASE_URL}/channels/leave`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        workspace_name: workspaceName,
                        channel_name: channelName
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message || "ì±„ë„ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                    // í˜„ì¬ ì±„ë„ì—ì„œ ë‚˜ê°„ í›„ ì²˜ë¦¬: ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ê±°ë‚˜ ì±„ë„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    localStorage.removeItem("current_channel_name"); // í˜„ì¬ ì±„ë„ ì´ˆê¸°í™”
                    location.reload(); // ë˜ëŠ” ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì´ë™
                } else {
                    alert(`âŒ ${data.detail || "ì±„ë„ ë‚˜ê°€ê¸° ì‹¤íŒ¨"}`);
                }
            } catch (error) {
                console.error("ì±„ë„ ë‚˜ê°€ê¸° ì¤‘ ì˜¤ë¥˜:", error);
                alert("ì±„ë„ ë‚˜ê°€ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    
        // íŒ€ì› ìƒˆë¡œê³ ì¹¨
        async function refreshTeamMembers() {
            await loadTeamMembers();
        }

        // íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        async function refreshFiles() {
            if (currentChannelName) {
                await loadChannelFiles(currentChannelName);
                renderFiles();
                updateChannelContent();
            }
        }
    
        // ì±„ë„ ë°ì´í„° ë¡œë”©
        async function loadChannelData(channelName) {
            try {
                // ë©”ì‹œì§€ ì´ˆê¸°í™” (WebSocketìœ¼ë¡œ ë°›ì„ ì˜ˆì •)
                if (!globalData.messages[channelName]) {
                    globalData.messages[channelName] = [];
                }
                
                // íŒŒì¼ ëª©ë¡ ë¡œë”©
                await loadChannelFiles(channelName);
                
                console.log(`ğŸ“š ì±„ë„ ${channelName} ë°ì´í„° ì´ˆê¸°í™”`);
            } catch (error) {
                console.error('ì±„ë„ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
            }
        }

        // ì±„ë„ íŒŒì¼ ëª©ë¡ ë¡œë”©
        async function loadChannelFiles(channelName) {
            try {
                const workspaceName = globalData.workspace?.name;
                if (!workspaceName) {
                    console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                console.log(`ğŸ“ ì±„ë„ íŒŒì¼ ë¡œë”© ì‹œì‘ - ì±„ë„: ${channelName}, ì›Œí¬ìŠ¤í˜ì´ìŠ¤: ${workspaceName}`);

                const files = await apiCall(`/channels/${channelName}/files?workspace_name=${encodeURIComponent(workspaceName)}`, {
                    method: 'GET'
                });

                console.log('ğŸ“ íŒŒì¼ ëª©ë¡ ì‘ë‹µ:', files);

                // ì‘ë‹µì´ ë°°ì—´ì¸ì§€ í™•ì¸í•˜ê³  ì²˜ë¦¬
                let fileArray = [];
                if (Array.isArray(files)) {
                    fileArray = files;
                    console.log('âœ… ì§ì ‘ ë°°ì—´ ì²˜ë¦¬ - íŒŒì¼ ê°œìˆ˜:', fileArray.length);
                } else if (files && files.files && Array.isArray(files.files)) {
                    fileArray = files.files;
                    console.log('âœ… files ì†ì„± ì²˜ë¦¬ - íŒŒì¼ ê°œìˆ˜:', fileArray.length);
                } else {
                    console.error('âŒ ì˜ˆìƒí•˜ì§€ ëª»í•œ ì‘ë‹µ êµ¬ì¡°:', files);
                    fileArray = [];
                }

                // íŒŒì¼ ë°ì´í„° ë³€í™˜
                globalData.files[channelName] = fileArray.map(file => ({
                    file_id: file.file_id,
                    filename: file.filename,
                    uploaded_by: file.uploaded_by,
                    uploaded_at: file.uploaded_at,
                    min_role_name: file.min_role_name,
                    valid_from: file.valid_from,
                    valid_to: file.valid_to
                }));

                console.log('âœ… ìµœì¢… ë³€í™˜ëœ íŒŒì¼ ëª©ë¡:', globalData.files[channelName]);
                console.log('âœ… ìµœì¢… íŒŒì¼ ê°œìˆ˜:', globalData.files[channelName].length);

            } catch (error) {
                console.error('âŒ íŒŒì¼ ë¡œë”© ì‹¤íŒ¨:', error);
                globalData.files[channelName] = [];
            }
        }
    
        // ì±„ë„ ì „í™˜
        async function switchChannel(channelName) {
            try {
                // ì´ì „ WebSocket ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
                cleanupWebSocketOnNavigation();
                
                currentChannelName = channelName;

                // âœ… ì±„ë„ ì´ë¦„ì„ localStorageì— ì €ì¥
                localStorage.setItem("current_channel_name", channelName);
                
                const channel = globalData.channels.find(ch => ch.name === channelName);
                if (!channel) return;
    
                globalData.currentChannel = channel;
                
                // ì±„ë„ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë”©
                if (!globalData.messages[channelName]) {
                    await loadChannelData(channelName);
                }
                
                renderChannelList();
                document.getElementById('current-channel-title').textContent = `# ${channel.name}`;
                document.getElementById('current-channel-description').textContent = 
                    channel.is_default ? 'ê¸°ë³¸ ì±„ë„ì…ë‹ˆë‹¤' : (channel.is_public ? 'ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤' : 'ë¹„ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤');
                
                const typeBadge = document.getElementById('channel-type-badge');
                if (channel.is_public) {
                    typeBadge.textContent = 'ğŸŒ ê³µê°œ';
                    typeBadge.className = 'channel-badge public';
                } else {
                    typeBadge.textContent = 'ğŸ”’ ë¹„ê³µê°œ';
                    typeBadge.className = 'channel-badge private';
                }
                
                document.getElementById('message-input').placeholder = `# ${channel.name} ì±„ë„ì— ë©”ì‹œì§€ ë³´ë‚´ê¸°`;
                updateChannelContent();

                // ìƒˆ ì±„ë„ë¡œ WebSocket ì—°ê²° (ë” ê¸´ ì§€ì—° ì‹œê°„)
                setTimeout(() => {
                    connectWebSocket();
                }, 300);
    
            } catch (error) {
                console.error('ì±„ë„ ì „í™˜ ì‹¤íŒ¨:', error);
            }
        }
    
        function updateChannelContent() {
            const channel = globalData.currentChannel;
            if (!channel) return;
    
            const messages = globalData.messages[channel.name] || [];
            const files = globalData.files[channel.name] || [];
            
            document.getElementById('message-count').textContent = messages.length;
            document.getElementById('file-count').textContent = files.length;
    
            renderMessages();
            renderFiles();
        }
    
        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            currentTab = tabName;
            
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
            
            // íŒŒì¼ íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì¬ì„¤ì •
            if (tabName === 'files') {
                setTimeout(() => {
                    setupDragAndDrop();
                }, 100);
            }
            
            // ì±„íŒ… íƒ­ìœ¼ë¡œ ì „í™˜ ì‹œ ìŠ¤í¬ë¡¤ í•¸ë“¤ëŸ¬ ì¬ì„¤ì •
            if (tabName === 'chat') {
                setTimeout(() => {
                    setupScrollHandler();
                }, 100);
            }
        }
    
        // ë©”ì‹œì§€ ë Œë”ë§
        function renderMessages() {
            const messagesContainer = document.getElementById('chat-messages');
            const messages = globalData.messages[currentChannelName] || [];
            const channel = globalData.currentChannel;
            
            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="welcome-section" id="welcome-message">
                        <div class="welcome-icon">ğŸ </div>
                        <div class="welcome-title"># ${channel?.name || 'ì±„ë„'}ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</div>
                        <div class="welcome-description">
                            ${channel?.is_public ? 'ëª¨ë“  ë©¤ë²„ê°€ ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤.' : 'ì´ˆëŒ€ë°›ì€ ë©¤ë²„ë§Œ ì°¸ì—¬í•  ìˆ˜ ìˆëŠ” ë¹„ê³µê°œ ì±„ë„ì…ë‹ˆë‹¤.'} ììœ ë¡­ê²Œ ì†Œí†µí•˜ê³  íŒŒì¼ì„ ê³µìœ í•˜ì„¸ìš”. â­
                        </div>
                    </div>
                `;
                return;
            }
            
            messagesContainer.innerHTML = messages.map(message => {
                const messageTime = new Date(message.timestamp || message.created_at).toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                const userDisplayName = message.user_email || message.user_name || 'Unknown';
                const avatarLetter = userDisplayName.charAt(0).toUpperCase();
                
                return `
                    <div class="message">
                        <div class="message-avatar">${avatarLetter}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${userDisplayName}</span>
                                <span class="message-time">${messageTime}</span>
                            </div>
                            <div class="message-text">${message.content.replace(/\n/g, '<br>')}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™ (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
            setTimeout(() => {
                messagesContainer.scrollTo({
                    top: messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function setupScrollHandler() {
            const messagesContainer = document.querySelector('.chat-messages-container');
            if (!messagesContainer) return;
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            messagesContainer.removeEventListener('scroll', handleScroll);
            
            // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            messagesContainer.addEventListener('scroll', handleScroll);
            
            function handleScroll() {
                // ìŠ¤í¬ë¡¤ì´ ë§¨ ìœ„ì— ê°€ê¹Œì›Œì§€ë©´ ë” ì´ì „ ë©”ì‹œì§€ ìš”ì²­
                if (messagesContainer.scrollTop <= 100 && !globalData.isLoadingOlderMessages) {
                    const messages = globalData.messages[currentChannelName] || [];
                    if (messages.length > 0) {
                        const oldestMessage = messages[0];
                        if (oldestMessage && oldestMessage.timestamp) {
                            globalData.isLoadingOlderMessages = true;
                            
                            // ë¡œë”© í‘œì‹œ (ë©”ì‹œì§€ ì—†ì´ ìŠ¤í”¼ë„ˆë§Œ)
                            const loadingDiv = document.createElement('div');
                            loadingDiv.className = 'loading-older-messages';
                            loadingDiv.innerHTML = `
                                <div class="loading-spinner"></div>
                            `;
                            const chatMessages = document.getElementById('chat-messages');
                            if (chatMessages) {
                                chatMessages.insertBefore(loadingDiv, chatMessages.firstChild);
                            }
                            
                            // WebSocketìœ¼ë¡œ ì´ì „ ë©”ì‹œì§€ ìš”ì²­
                            if (websocket && websocket.readyState === WebSocket.OPEN) {
                                websocket.send(JSON.stringify({
                                    type: 'load_older_messages',
                                    before_timestamp: oldestMessage.timestamp
                                }));
                            }
                        }
                    }
                }
            }
        }
        

    
        // ë©”ì‹œì§€ ì „ì†¡ (WebSocket ì‚¬ìš©)
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const content = input.value.trim();
            
            if (!content || !currentChannelName || !websocket || websocket.readyState !== WebSocket.OPEN) {
                if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                    alert('ì±„íŒ… ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
                return;
            }
    
            try {
                // WebSocketìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
                const messageData = {
                    type: 'message',
                    content: content,
                    message_type: 'text',
                    timestamp: new Date().toISOString()
                };
                
                websocket.send(JSON.stringify(messageData));
                
                input.value = '';
                input.style.height = 'auto';
                updateSendButton();
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    
                // íŒŒì¼ ë Œë”ë§
        function renderFiles() {
            const filesContainer = document.getElementById('files-list');
            const files = globalData.files[currentChannelName] || [];
            
            if (files.length === 0) {
                filesContainer.innerHTML = `
                    <div class="welcome-section" id="files-welcome-message">
                        <div class="welcome-icon">ğŸ“</div>
                        <div class="welcome-title">íŒŒì¼ ê´€ë¦¬</div>
                        <div class="welcome-description">
                            íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  íŒ€ì›ë“¤ê³¼ ê³µìœ í•˜ì„¸ìš”. â­ 
                        </div>
                    </div>
                `;
                return;
            }

            filesContainer.innerHTML = files.map(file => {
                const uploadTime = new Date(file.uploaded_at).toLocaleString('ko-KR');
                const currentUser = globalData.user?.user_email;
                const canDelete = file.uploaded_by === currentUser; // ì—…ë¡œë”ë§Œ ì‚­ì œ ê°€ëŠ¥
                
                // ê¶Œí•œ ì •ë³´ í‘œì‹œ
                let permissionInfo = '';
                if (file.min_role_name) {
                    permissionInfo += ` â€¢ ìµœì†Œ ê¶Œí•œ: ${file.min_role_name}`;
                }
                if (file.valid_from || file.valid_to) {
                    const fromDate = file.valid_from ? new Date(file.valid_from).toLocaleDateString('ko-KR') : 'ë¬´ì œí•œ';
                    const toDate = file.valid_to ? new Date(file.valid_to).toLocaleDateString('ko-KR') : 'ë¬´ì œí•œ';
                    permissionInfo += ` â€¢ ìœ íš¨ê¸°ê°„: ${fromDate} ~ ${toDate}`;
                }
                
                return `
                    <div class="file-item">
                        <div class="file-icon">ğŸ“„</div>
                        <div class="file-info">
                            <div class="file-name">${file.filename}</div>
                            <div class="file-meta">
                                ì—…ë¡œë“œ: ${file.uploaded_by} â€¢ ${uploadTime}${permissionInfo}
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn download" onclick="downloadFile(${file.file_id}, '${file.filename}')" title="ë‹¤ìš´ë¡œë“œ">ğŸ“¥</button>
                            ${canDelete ? `<button class="file-action-btn delete" onclick="deleteFile(${file.file_id}, '${file.filename}')" title="ì‚­ì œ">ğŸ—‘ï¸</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
    
        // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        async function downloadFile(fileId, filename) {
            try {
                const token = localStorage.getItem('jwt_token') || localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/files/${fileId}/download`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
                }

                // íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                // í•œê¸€ íŒŒì¼ëª…ì„ ìœ„í•œ ë””ì½”ë”© ì²˜ë¦¬
                try {
                    a.download = decodeURIComponent(filename);
                } catch (e) {
                    a.download = filename;
                }
                
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                console.log(`âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${filename}`);
            } catch (error) {
                console.error('íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // íŒŒì¼ ì‚­ì œ (ì—…ë¡œë”ë§Œ ê°€ëŠ¥)
        async function deleteFile(fileId, filename) {
            if (!confirm(`"${filename}" íŒŒì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const token = localStorage.getItem('jwt_token') || localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/files/${fileId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`ì‚­ì œ ì‹¤íŒ¨: ${response.status}`);
                }

                // íŒŒì¼ ëª©ë¡ì—ì„œ ì‚­ì œëœ íŒŒì¼ ì œê±°
                if (globalData.files[currentChannelName]) {
                    globalData.files[currentChannelName] = globalData.files[currentChannelName].filter(
                        file => file.file_id !== fileId
                    );
                }

                renderFiles();
                updateChannelContent();
                console.log(`âœ… íŒŒì¼ ì‚­ì œ ì™„ë£Œ: ${filename}`);
            } catch (error) {
                console.error('íŒŒì¼ ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('íŒŒì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
    
        // ë©”ì‹œì§€ ì…ë ¥ ê´€ë ¨
        function updateSendButton() {
            const sendBtn = document.getElementById('send-btn');
            const hasText = document.getElementById('message-input').value.trim().length > 0;
            const isConnected = websocket && websocket.readyState === WebSocket.OPEN;
            sendBtn.disabled = !hasText || !isConnected;
        }
    
        // ì—­í•  ëª©ë¡ ë¡œë“œ
        async function loadRoles() {
            try {
                const roles = await apiCall('/workspaces/roles');
                const roleSelect = document.getElementById('min-role');
                
                // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ "ëª¨ë“  ì§ê¸‰" ì˜µì…˜ ì œì™¸)
                while (roleSelect.children.length > 1) {
                    roleSelect.removeChild(roleSelect.lastChild);
                }
                
                // ì—­í•  ëª©ë¡ ì¶”ê°€
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.textContent = `${role.name} ì´ìƒ`;
                    roleSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('ì—­í•  ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ì‹œ ê¸°ë³¸ ì—­í•  ëª©ë¡ ì‚¬ìš©
                const roleSelect = document.getElementById('min-role');
                const defaultRoles = ['ì‚¬ì›', 'ëŒ€ë¦¬', 'ê³¼ì¥', 'íŒ€ì¥', 'ë¶€ì¥', 'ì´ì‚¬'];
                
                defaultRoles.forEach(roleName => {
                    const option = document.createElement('option');
                    option.value = roleName;
                    option.textContent = `${roleName} ì´ìƒ`;
                    roleSelect.appendChild(option);
                });
            }
        }

        // íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨
        function triggerFileUpload() {
            document.getElementById('file-input').click();
        }
    
        function attachFile() {
            triggerFileUpload();
        }

        // ì„ íƒëœ íŒŒì¼ë“¤
        let selectedFiles = [];

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        document.getElementById('file-input').addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                selectedFiles = files;
                showUploadOptions();
            }
        });

        // ì—…ë¡œë“œ ì˜µì…˜ í‘œì‹œ
        function showUploadOptions() {
            const uploadOptions = document.getElementById('upload-options');
            uploadOptions.style.display = 'block';
            uploadOptions.scrollIntoView({ behavior: 'smooth' });
        }

        // íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
        async function uploadFile(file) {
            const minRole = document.getElementById('min-role').value;
            const validFrom = document.getElementById('valid-from').value;
            const validTo = document.getElementById('valid-to').value;

            const formData = new FormData();
            formData.append('file', file);
            if (minRole) formData.append('min_role_name', minRole);
            if (validFrom) formData.append('valid_from', validFrom);
            if (validTo) formData.append('valid_to', validTo);

            const token = localStorage.getItem('jwt_token') || localStorage.getItem('access_token');
            const workspaceName = localStorage.getItem('current_workspace_name');
            const response = await fetch(`${API_BASE_URL}/channels/${currentChannelName}/files?workspace_name=${encodeURIComponent(workspaceName)}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ${response.status}`);
            }

            const result = await response.json();
            
            // íŒŒì¼ ì—…ë¡œë“œ í›„ íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            await loadChannelFiles(currentChannelName);
            renderFiles();
            updateChannelContent();
        }

        // ì„ íƒëœ íŒŒì¼ë“¤ ì—…ë¡œë“œ
        async function handleFileUpload() {
            if (selectedFiles.length === 0) return;

            try {
                for (const file of selectedFiles) {
                    await uploadFile(file);
                }
                
                // ì—…ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
                selectedFiles = [];
                document.getElementById('upload-options').style.display = 'none';
                document.getElementById('file-input').value = '';
                resetUploadForm();
                
            } catch (error) {
                console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                alert(`íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // ì—…ë¡œë“œ í¼ ì´ˆê¸°í™”
        function resetUploadForm() {
            document.getElementById('min-role').value = '';
            document.getElementById('valid-from').value = '';
            document.getElementById('valid-to').value = '';
        }
    
        // íŒŒì¼ í¬ê¸° í¬ë§·íŒ…
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('upload-area');
            const filesMessages = document.getElementById('files-messages');
    
            if (!uploadArea || !filesMessages) {
                console.warn('ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
    
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
                filesMessages.addEventListener(eventName, preventDefaults, false);
            });
    
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
    
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
    
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
    
            function highlight(e) {
                uploadArea.classList.add('drag-over');
            }
    
            function unhighlight(e) {
                uploadArea.classList.remove('drag-over');
            }
    
            uploadArea.addEventListener('drop', handleDrop, false);
    
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                handleFiles(files);
            }
    
            function handleFiles(files) {
                const fileInput = document.getElementById('file-input');
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
            
            // íŒŒì¼ íƒ­ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
            setupFilesScrollHandler();
        }
        
        // íŒŒì¼ íƒ­ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        function setupFilesScrollHandler() {
            const filesMessages = document.querySelector('.chat-messages-container');
            if (!filesMessages) return;
            
            // íŒŒì¼ íƒ­ì—ì„œëŠ” ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ë§Œ ê°ì§€ (í™˜ì˜ ì„¹ì…˜ ìˆ¨ê¹€/í‘œì‹œ ì œê±°)
            filesMessages.addEventListener('scroll', function() {
                // í•„ìš”ì‹œ íŒŒì¼ ê´€ë ¨ ìŠ¤í¬ë¡¤ ì²˜ë¦¬ ì¶”ê°€ ê°€ëŠ¥
            });
        }
    
        // ê¸°íƒ€ ê¸°ëŠ¥ë“¤
        function addEmoji() {
            const input = document.getElementById('message-input');
            const emojis = ['ğŸ˜Š', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'ğŸ’¯', 'ğŸ”¥', 'âœ¨', 'ğŸš€', 'ğŸ‘', 'ğŸ’ª'];
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + randomEmoji + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + 2, cursorPos + 2);
            updateSendButton();
        }
    
        function mentionUser() {
            const input = document.getElementById('message-input');
            const members = globalData.teamMembers || [];
            
            if (members.length === 0) {
                alert('ë©˜ì…˜í•  ìˆ˜ ìˆëŠ” íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
    
            // ê°„ë‹¨í•œ ë©˜ì…˜ êµ¬í˜„
            const randomMember = members[Math.floor(Math.random() * members.length)];
            const mention = `@${randomMember.user_email.split('@')[0]} `;
            
            const cursorPos = input.selectionStart;
            const textBefore = input.value.substring(0, cursorPos);
            const textAfter = input.value.substring(cursorPos);
            
            input.value = textBefore + mention + textAfter;
            input.focus();
            input.setSelectionRange(cursorPos + mention.length, cursorPos + mention.length);
            updateSendButton();
        }
    
        function voiceMessage() {
            alert('ìŒì„± ë©”ì‹œì§€ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
        }
    
        function closeNewChannelModal() {
            document.getElementById('new-channel-modal').style.display = 'none';
        }
    
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl+K: ë¹ ë¥¸ ì±„ë„ ê²€ìƒ‰
                if (e.ctrlKey && e.key === 'k') {
                    e.preventDefault();
                    alert('ë¹ ë¥¸ ì±„ë„ ê²€ìƒ‰ ê¸°ëŠ¥ì€ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.');
                }
                
                // Ctrl+/: ë‹¨ì¶•í‚¤ ë„ì›€ë§
                if (e.ctrlKey && e.key === '/') {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }
            });
        }
    
        function showKeyboardShortcuts() {
            alert(`
    âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
    
    ğŸ’¬ ë©”ì‹œì§€
    â€¢ Enter: ë©”ì‹œì§€ ì „ì†¡
    â€¢ Shift+Enter: ì¤„ë°”ê¿ˆ
    
    ğŸ” íƒìƒ‰
    â€¢ Ctrl+K: ë¹ ë¥¸ ì±„ë„ ê²€ìƒ‰
    â€¢ â†‘/â†“: ì±„ë„ ëª©ë¡ íƒìƒ‰
    
    âš™ï¸ ê¸°íƒ€
    â€¢ Ctrl+/: ë‹¨ì¶•í‚¤ ë„ì›€ë§
    â€¢ F5: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
            `);
        }
    
        // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ (ìƒˆ ì±„ë„ ì•Œë¦¼ ë“±)
        function handleUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const newChannel = urlParams.get('new_channel');
            
            if (newChannel) {
                document.getElementById('new-channel-message').textContent = 
                    `'${newChannel}' ì±„ë„ì´ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`;
                document.getElementById('new-channel-modal').style.display = 'flex';
                
                // URLì—ì„œ íŒŒë¼ë¯¸í„° ì œê±°
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    
        // ìë™ ì €ì¥ ê¸°ëŠ¥ (ë©”ì‹œì§€ ì„ì‹œ ì €ì¥)
        function setupAutoSave() {
            const messageInput = document.getElementById('message-input');
            const STORAGE_KEY = 'draft_message_';
            
            // ë©”ì‹œì§€ ì„ì‹œ ì €ì¥
            messageInput.addEventListener('input', function() {
                if (currentChannelName) {
                    localStorage.setItem(STORAGE_KEY + currentChannelName, this.value);
                }
            });
            
            // ì±„ë„ ë³€ê²½ ì‹œ ì„ì‹œ ì €ì¥ëœ ë©”ì‹œì§€ ë³µì›
            function restoreDraftMessage() {
                if (currentChannelName) {
                    const draft = localStorage.getItem(STORAGE_KEY + currentChannelName);
                    if (draft) {
                        messageInput.value = draft;
                        updateSendButton();
                    }
                }
            }
            
            // ë©”ì‹œì§€ ì „ì†¡ í›„ ì„ì‹œ ì €ì¥ ì‚­ì œ
            const originalSendMessage = sendMessage;
            window.sendMessage = async function() {
                await originalSendMessage();
                if (currentChannelName) {
                    localStorage.removeItem(STORAGE_KEY + currentChannelName);
                }
            };
            
            return restoreDraftMessage;
        }
    
        // í˜ì´ì§€ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸŒŠ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë©”ì¸ í˜ì´ì§€ ë¡œë”© ì¤‘...');
            
            document.getElementById('loading-overlay').style.display = 'flex';
            
            // ê¸°ëŠ¥ ì´ˆê¸°í™”
            const restoreDraftMessage = setupAutoSave();
            setupKeyboardShortcuts();
            handleUrlParameters();
            
            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ˆê¸°í™” í›„ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            initializeWorkspace().then(() => {
                restoreDraftMessage();
                setupDragAndDrop();
                
                // ì—­í•  ëª©ë¡ ë¡œë“œ
                loadRoles();
                
                // ë‚ ì§œ ì…ë ¥ ê¸°ë³¸ê°’ ì„¤ì •
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('valid-from').min = today;
                document.getElementById('valid-to').min = today;

                // ì¢…ë£Œì¼ì€ ì‹œì‘ì¼ ì´í›„ë¡œ ì œí•œ
                document.getElementById('valid-from').addEventListener('change', function() {
                    document.getElementById('valid-to').min = this.value;
                });

                // ì—…ë¡œë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                document.getElementById('upload-submit-btn').addEventListener('click', handleFileUpload);
            });
            

            
            updateSendButton();
            
            // ë©”ì‹œì§€ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const messageInput = document.getElementById('message-input');
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                updateSendButton();
            });
    
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // ì£¼ê¸°ì ìœ¼ë¡œ ì—°ê²° ìƒíƒœ í™•ì¸ ë° WebSocket ìƒíƒœ ëª¨ë‹ˆí„°ë§
            setInterval(() => {
                updateSendButton(); // WebSocket ìƒíƒœì— ë”°ë¼ ì „ì†¡ ë²„íŠ¼ ì—…ë°ì´íŠ¸
                
                if (websocket && websocket.readyState !== WebSocket.OPEN && currentChannelName) {
                    updateConnectionStatus('offline');
                    if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                        attemptReconnect();
                    }
                }
            }, 5000); // 5ì´ˆë§ˆë‹¤ í™•ì¸
        });
    
        // ì•ˆì „í•œ ì›¹ì†Œì¼“ ì—°ê²° í•´ì œ í•¨ìˆ˜
        function safeCloseWebSocket() {
            if (websocket) {
                if (websocket.readyState === WebSocket.OPEN || websocket.readyState === WebSocket.CONNECTING) {
                    try {
                        websocket.close(1000, 'Page navigation');
                        console.log('âœ… WebSocket ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œë¨');
                    } catch (e) {
                        console.log('WebSocket ì—°ê²° ì¢…ë£Œ ì‹¤íŒ¨:', e);
                    }
                }
                websocket = null;
                // ì—°ê²° ìƒíƒœ ì´ˆê¸°í™”
                updateConnectionStatus('offline');
                reconnectAttempts = 0;
            }
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ WebSocket ì—°ê²° í•´ì œ
        window.addEventListener('beforeunload', function() {
            safeCloseWebSocket();
        });

        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ WebSocket ì—°ê²° ê´€ë¦¬
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì§ˆ ë•Œ WebSocket ì—°ê²° ì•ˆì „í•˜ê²Œ ì¢…ë£Œ
                safeCloseWebSocket();
            } else {
                // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì¼ ë•Œ WebSocket ì¬ì—°ê²°
                if (currentChannelName && !websocket) {
                    setTimeout(() => {
                        connectWebSocket();
                    }, 500);
                }
            }
        });

        // í˜ì´ì§€ ì „í™˜ ì‹œ ì›¹ì†Œì¼“ ì—°ê²° ì •ë¦¬
        function cleanupWebSocketOnNavigation() {
            console.log('ğŸ”„ í˜ì´ì§€ ì „í™˜ìœ¼ë¡œ ì¸í•œ ì›¹ì†Œì¼“ ì—°ê²° ì •ë¦¬');
            safeCloseWebSocket();
            // ì¬ì—°ê²° ì‹œë„ ì¤‘ì§€
            reconnectAttempts = MAX_RECONNECT_ATTEMPTS + 1;
        }
    </script>
</body>
</html>