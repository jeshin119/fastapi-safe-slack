<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 페이지 - 회원 관리</title>
    
    <!-- CSS 파일들 임포트 -->
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/admin-members.css">
    
</head>
<body>
    <!-- 배경 장식 -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>

    <div class="admin-container">
        <!-- 헤더 -->
        <div class="header-section">
            <div class="admin-badge">👑 관리자</div>
            <div class="logo">🌊</div>
            <h1 class="welcome-text">멤버 관리</h1>
            <p class="subtitle">워크스페이스 멤버들의 가입 승인과<br>권한 관리를 수행하세요</p>
        </div>

        <!-- 워크스페이스 정보 -->
        <div class="workspace-info">
            <div class="workspace-icon">🚀</div>
            <div class="workspace-details">
                <div class="workspace-name" id="workspace-name"></div>
                <div class="workspace-meta">데이터 로딩 중...</div>
            </div>
        </div>

        <!-- 통계 섹션 -->
        <div class="stats-section">
            <div class="section-title">📊 멤버 현황</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">👥</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">전체 멤버</div>
                    <div class="stat-change neutral">로딩 중</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">⏳</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">승인 대기</div>
                    <div class="stat-change neutral">로딩 중</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">✅</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">활성 멤버</div>
                    <div class="stat-change neutral">로딩 중</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">🚫</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">정지된 멤버</div>
                    <div class="stat-change neutral">로딩 중</div>
                </div>
            </div>
        </div>

        <!-- 탭 섹션 -->
        <div class="tab-section">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('pending')" id="pending-tab">
                    승인 대기
                </button>
                <button class="tab-button" onclick="switchTab('active')" id="active-tab">
                    활성 멤버
                </button>
                <button class="tab-button" onclick="switchTab('suspended')" id="suspended-tab">
                    정지된 멤버
                </button>
            </div>

            <!-- 승인 대기 탭 -->
            <div class="tab-content active" id="pending-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="이름, 이메일로 검색..." id="pending-search">
                    <select class="filter-select" id="pending-filter">
                        <option value="all">모든 요청</option>
                        <option value="recent">최근 요청</option>
                        <option value="old">오래된 요청</option>
                    </select>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="inviteMembers()">
                            ➕ 멤버 초대
                        </button>
                    </div>
                </div>

                <div class="members-grid" id="pending-list">
                    <div class="loading-state">
                        <div class="loading-spinner-large"></div>
                        <div>승인 대기 멤버를 불러오고 있습니다...</div>
                    </div>
                </div>
            </div>

            <!-- 활성 멤버 탭 -->
            <div class="tab-content" id="active-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="이름, 이메일로 검색..." id="active-search">
                    <select class="filter-select" id="active-filter">
                        <option value="all">모든 멤버</option>
                        <option value="admin">관리자</option>
                        <option value="member">일반 멤버</option>
                        <option value="contractor">파견직</option>
                    </select>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="exportMembers()">
                            📤 내보내기
                        </button>
                        <button class="btn btn-primary" onclick="inviteMembers()">
                            ➕ 멤버 초대
                        </button>
                    </div>
                </div>

                <div class="members-grid" id="active-members-list">
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <div class="empty-title">활성 멤버가 표시됩니다</div>
                        <div class="empty-description">승인된 멤버들이 여기에 나타납니다.</div>
                    </div>
                </div>
            </div>

            <!-- 정지된 멤버 탭 -->
            <div class="tab-content" id="suspended-content">
                <div class="empty-state">
                    <div class="empty-icon">🚫</div>
                    <div class="empty-title">정지된 멤버가 없습니다</div>
                    <div class="empty-description">현재 정지된 멤버가 없습니다.<br>필요시 멤버 관리에서 정지 조치를 취할 수 있습니다.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 승인 모달 -->
    <div class="modal-overlay" id="approval-modal">
        <div class="modal approval-modal">
            <div class="modal-header">
                <div class="modal-icon">✅</div>
                <div class="modal-title">멤버 승인</div>
                <div class="modal-description">가입 승인 및 설정을 진행합니다</div>
            </div>
            
            <!-- 신청자 정보 -->
            <div class="applicant-info" id="applicant-info">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 이름:</strong> <span id="applicant-name">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 이메일:</strong> <span id="applicant-email">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 신청 직급:</strong> <span id="applicant-role">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 초대 코드:</strong> <span id="applicant-code">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 파견직:</strong></span>
                    <div class="radio-group" style="margin: 0;">
                        <label style="margin-right: 8px;">
                            <input type="radio" name="is_contractor" value="false" checked>
                            No
                        </label>
                        <label>
                            <input type="radio" name="is_contractor" value="true">
                            Yes
                        </label>
                    </div>
                </div>
                <!-- 만료일 설정 -->
                <div id="expires-section" style="display: none; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>• 만료일:</strong></span>
                        <div class="date-inputs" style="margin: 0;">
                            <select id="expire-year" required style="min-width: 65px;">
                                <option value="">년</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                            </select>
                            <span>년</span>
                            
                            <select id="expire-month" required style="min-width: 50px;">
                                <option value="">월</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <span>월</span>
                            
                            <select id="expire-day" required style="min-width: 50px;">
                                <option value="">일</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                <option value="23">23</option>
                                <option value="24">24</option>
                                <option value="25">25</option>
                                <option value="26">26</option>
                                <option value="27">27</option>
                                <option value="28">28</option>
                                <option value="29">29</option>
                                <option value="30">30</option>
                                <option value="31">31</option>
                            </select>
                            <span>일</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 최종 직급 설정 -->
            <div class="form-group">
                <label class="form-label">
                    최종 직급 <span class="required">*</span>
                </label>
                <select class="role-select" id="final-role">
                    <option value="">직급을 선택하세요</option>
                    <option value="사원">사원</option>
                    <option value="대리">대리</option>
                    <option value="과장">과장</option>
                    <option value="팀장">팀장</option>
                    <option value="부장">부장</option>
                    <option value="이사">이사</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeApprovalModal()">취소</button>
                <button class="btn btn-primary" id="confirm-approval-btn" onclick="confirmApproval()">
                    <div class="loading-spinner" id="approval-spinner"></div>
                    <span id="approval-text">승인하기</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 확인 모달 -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modal-icon">⚠️</div>
                <div class="modal-title" id="modal-title">작업 확인</div>
                <div class="modal-description" id="modal-description">이 작업을 수행하시겠습니까?</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                <button class="btn btn-primary" id="confirm-btn" onclick="confirmAction()">
                    <div class="loading-spinner" id="modal-spinner"></div>
                    <span id="confirm-text">확인</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        const API_BASE_URL = 'http://localhost:8000';
        let currentAction = null;
        let targetMember = null;
        let approvalMember = null;

        // API에서 받은 실제 데이터로 통계 업데이트
        function updateStatisticsFromAPI(stats) {
            // 워크스페이스 메타 정보 업데이트
            const workspaceMeta = document.querySelector('.workspace-meta');
            if (workspaceMeta) {
                workspaceMeta.textContent = `총 ${stats.totalMembers}명의 멤버 • ${stats.pendingCount}명 승인 대기 중`;
            }
            
            // 통계 카드들 업데이트
            const statNumbers = document.querySelectorAll('.stat-number');
            const statChanges = document.querySelectorAll('.stat-change');
            
            if (statNumbers[0]) statNumbers[0].textContent = stats.totalMembers;
            if (statNumbers[1]) statNumbers[1].textContent = stats.pendingCount;
            if (statNumbers[2]) statNumbers[2].textContent = stats.activeMembers;
            if (statNumbers[3]) statNumbers[3].textContent = stats.suspendedMembers;
            
            // 변화량 업데이트
            if (statChanges[0]) {
                statChanges[0].textContent = stats.weeklyChange > 0 ? `+${stats.weeklyChange} 이번 주` : '변화 없음';
                statChanges[0].className = `stat-change ${stats.weeklyChange > 0 ? 'positive' : 'neutral'}`;
            }
            if (statChanges[1]) {
                statChanges[1].textContent = stats.pendingCount > 0 ? '새 요청' : '대기 없음';
                statChanges[1].className = 'stat-change neutral';
            }
            if (statChanges[2]) {
                const activeRate = stats.totalMembers > 0 ? ((stats.activeMembers / stats.totalMembers) * 100).toFixed(1) : 0;
                statChanges[2].textContent = `${activeRate}%`;
                statChanges[2].className = `stat-change ${activeRate > 80 ? 'positive' : 'neutral'}`;
            }
            if (statChanges[3]) {
                statChanges[3].textContent = '변화 없음';
                statChanges[3].className = 'stat-change neutral';
            }
            
            // 승인 대기 탭 배지 업데이트
            const pendingTab = document.getElementById('pending-tab');
            const existingBadge = pendingTab.querySelector('.tab-badge');
            
            if (stats.pendingCount > 0) {
                if (!existingBadge) {
                    const badge = document.createElement('span');
                    badge.className = 'tab-badge';
                    badge.textContent = stats.pendingCount;
                    pendingTab.appendChild(badge);
                } else {
                    existingBadge.textContent = stats.pendingCount;
                }
            } else if (existingBadge) {
                existingBadge.remove();
            }
        }

        // API에서 받은 승인 대기 멤버들로 목록 업데이트
        function updatePendingMembersFromAPI(members) {
            const pendingList = document.getElementById('pending-list');
            
            if (members.length === 0) {
                pendingList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⏳</div>
                        <div class="empty-title">승인 대기 중인 멤버가 없습니다</div>
                        <div class="empty-description">새로운 가입 요청이 있으면 여기에 표시됩니다.</div>
                    </div>
                `;
                return;
            }
            
            pendingList.innerHTML = '';
            
            members.forEach(member => {
                const memberCard = createMemberCard(member);
                pendingList.appendChild(memberCard);
            });
        }

        // 멤버 카드 생성
        function createMemberCard(member) {
            const card = document.createElement('div');
            card.className = 'member-card';
            card.setAttribute('data-member-id', member.request_id || member.id);
            
            const firstChar = member.user_name ? member.user_name.charAt(0) : member.name.charAt(0);
            const requestDate = new Date(member.requested_at || member.created_at).toLocaleDateString('ko-KR');
            
            card.innerHTML = `
                <div class="member-header">
                    <div class="member-avatar">${firstChar}</div>
                    <div class="member-info">
                        <div class="member-name">${member.user_name || member.name}</div>
                        <div class="member-email">${member.user_email || member.email}</div>
                        <div class="member-status">
                            <span class="status-badge status-pending">⏳ 승인 대기</span>
                        </div>
                    </div>
                </div>
                <div class="member-meta">
                    <div class="meta-row">
                        <span class="meta-label">신청 직급</span>
                        <span class="meta-value">🏷️ ${member.role_name || member.requested_role}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">요청일</span>
                        <span class="meta-value">📅 ${requestDate}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">파견직</span>
                        <span class="meta-value">${member.is_contractor ? '✅ Yes' : '❌ No'}</span>
                    </div>
                </div>
                <div class="member-actions">
                    <button class="action-btn action-approve" onclick="approveMember(${member.request_id || member.id}, '${member.user_name || member.name}', '${member.user_email || member.email}', '${member.role_name || member.requested_role}')">
                        ✅ 승인
                    </button>
                    <button class="action-btn action-reject" onclick="rejectMember(${member.request_id || member.id}, '${member.user_name || member.name}')">
                        ❌ 거부
                    </button>
                </div>
            `;
            
            return card;
        }

        // 초기 데이터 로드 - 엔드포인트 수정됨!
        async function loadInitialData() {
            try {
                console.log('서버에서 데이터를 불러오는 중...');
                
                const token = localStorage.getItem('access_token');
                const workspaceName = localStorage.getItem("current_workspace_name");
                if (workspaceName) {
                    document.getElementById("workspace-name").textContent = workspaceName;
                } else {
                    document.getElementById("workspace-name").textContent = "워크스페이스 이름 없음";
                    console.warn("⚠️ 로컬스토리지에서 current_workspace_name을 찾을 수 없습니다.");
                }
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                
                // 가입 요청 목록 조회 (POST 방식으로 변경)
                const pendingResponse = await fetch(`${API_BASE_URL}/workspaces/join-requests-list`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        "workspace_name": workspaceName
                    })
                });
                
                // 멤버 목록 조회 (POST 방식으로 변경)
                const membersResponse = await fetch(`${API_BASE_URL}/workspaces/members`, {
                    method: 'POST', 
                    headers: headers,
                    body: JSON.stringify({
                        "workspace_name": workspaceName
                    })
                });
                
                const pendingData = await pendingResponse.json();
                const membersData = await membersResponse.json();
                console.log("✅ membersData:", membersData);

                // 여기서 호출!
                updateActiveMembersFromAPI(Array.isArray(membersData) ? membersData : []);
                
                // 통계 계산
                const stats = {
                    totalMembers: Array.isArray(membersData) ? membersData.length : 0,
                    pendingCount: Array.isArray(pendingData) ? pendingData.length : 0,
                    activeMembers: Array.isArray(membersData) ? membersData.length : 0,
                    suspendedMembers: 0,
                    weeklyChange: 0
                };
                
                updateStatisticsFromAPI(stats);
                updatePendingMembersFromAPI(Array.isArray(pendingData) ? pendingData : []);
                
                console.log('초기 데이터 로드 완료');
                
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                showErrorState();
            }
        }

        // 탭 전환
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // 승인 모달
        function approveMember(memberId, memberName, memberEmail, memberRole) {
            approvalMember = { 
                id: memberId, 
                name: memberName, 
                email: memberEmail, 
                role: memberRole
            };
            
            document.getElementById('applicant-name').textContent = memberName;
            document.getElementById('applicant-email').textContent = memberEmail;
            document.getElementById('applicant-role').textContent = memberRole;
            document.getElementById('applicant-code').textContent = '-';
            document.getElementById('final-role').value = memberRole;
            
            document.querySelector('input[name="is_contractor"][value="false"]').checked = true;
            document.getElementById('expires-section').style.display = 'none';
            
            document.getElementById('expire-year').value = '';
            document.getElementById('expire-month').value = '';
            document.getElementById('expire-day').value = '';
            
            document.getElementById('approval-modal').style.display = 'flex';
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').style.display = 'none';
            approvalMember = null;
        }

        // 승인 처리 - 엔드포인트 수정됨!
        async function confirmApproval() {
            if (!approvalMember) return;

            const finalRole = document.getElementById('final-role').value.trim();
            const isContractor = document.querySelector('input[name="is_contractor"]:checked').value === 'true';
            
            if (!finalRole) {
                alert('최종 직급을 선택해주세요.');
                return;
            }

            // 여기서 먼저 선언해줍니다
            let year, month, day;
            let expiresAt = null;

            if (isContractor) {
                const year = document.getElementById('expire-year').value;
                const month = document.getElementById('expire-month').value;
                const day = document.getElementById('expire-day').value;
                
                if (!year || !month || !day) {
                    alert('파견 만료일을 모두 입력해주세요.');
                    return;
                }
                
                expiresAt = `${year}-${month}-${day}T23:59:59`;
            }

            const confirmBtn = document.getElementById('confirm-approval-btn');
            const confirmText = document.getElementById('approval-text');
            const spinner = document.getElementById('approval-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = '승인 처리 중...';
            spinner.style.display = 'inline-block';

            try {
                const approvalData = {
                    user_name: approvalMember.name,
                    role_name: finalRole,
                    is_contractor: isContractor,
                    expires_at: expiresAt
                };

                const result = await approveMemberAPI(approvalMember.id, approvalData);
                
                if (result.success) {
                    const contractorText = isContractor ? ` (파견직, ~${year}.${month}.${day})` : ' (정규직)';
                    alert(`✅ ${approvalMember.name}님이 ${finalRole}${contractorText}으로 승인되었습니다!`);
                    
                    const memberCard = document.querySelector(`[data-member-id="${approvalMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            
                            const remainingCards = document.querySelectorAll('#pending-list .member-card');
                            if (remainingCards.length === 0) {
                                updatePendingMembersFromAPI([]);
                            }
                        }, 300);
                    }
                    
                    updateStatsAfterAction('approve');
                    closeApprovalModal();
                } else {
                    alert(`❌ 승인 실패: ${result.error}`);
                }
            } catch (error) {
                console.error('승인 처리 오류:', error);
                //alert('❌ 승인 처리 중 오류가 발생했습니다.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = '승인하기';
                spinner.style.display = 'none';
            }
        }

        // 거부 모달
        function rejectMember(memberId, memberName) {
            currentAction = 'reject';
            targetMember = { id: memberId, name: memberName };
            
            showModal(
                '❌',
                '가입 거부',
                `${memberName}님의 워크스페이스 가입 요청을 거부하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`,
                '거부하기'
            );
        }

        function showModal(icon, title, description, confirmText) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-description').textContent = description;
            document.getElementById('confirm-text').textContent = confirmText;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            currentAction = null;
            targetMember = null;
        }

        async function confirmAction() {
            if (!currentAction || !targetMember) return;

            const confirmBtn = document.getElementById('confirm-btn');
            const confirmText = document.getElementById('confirm-text');
            const spinner = document.getElementById('modal-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = '처리 중...';
            spinner.style.display = 'inline-block';

            try {
                let result;
                
                switch (currentAction) {
                    case 'reject':
                        result = await rejectMemberAPI(targetMember.id);
                        break;
                    default:
                        result = { success: false, error: '알 수 없는 작업입니다.' };
                }

                if (result.success) {
                    alert(`❌ ${targetMember.name}님의 가입 요청이 거부되었습니다.`);
                    
                    const memberCard = document.querySelector(`[data-member-id="${targetMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            
                            const remainingCards = document.querySelectorAll('#pending-list .member-card');
                            if (remainingCards.length === 0) {
                                updatePendingMembersFromAPI([]);
                            }
                        }, 300);
                    }
                    
                    updateStatsAfterAction('reject');
                    closeModal();
                } else {
                    alert(`❌ 오류: ${result.error}`);
                }
            } catch (error) {
                alert('❌ 처리 중 오류가 발생했습니다.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = '거부하기';
                spinner.style.display = 'none';
            }
        }

        // API 호출 함수들 - 엔드포인트 수정됨!
        async function approveMemberAPI(memberId, approvalData) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/workspaces/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "request_id": parseInt(memberId),
                        "user_name": approvalData.user_name,
                        "role_name": approvalData.role_name,
                        "is_contractor": approvalData.is_contractor,
                        "expires_at": approvalData.expires_at
                    })
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const data = await response.json();
                    return { success: false, error: data.detail || '승인에 실패했습니다.' };
                }
            } catch (error) {
                return { success: false, error: '서버 연결에 실패했습니다.' };
            }
        }

        async function rejectMemberAPI(memberId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/workspaces/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "request_id": parseInt(memberId),
                        "user_name": "김윤수",  // 실제 사용자명으로 변경 필요
                        "reason": "기준 구성원 승인 기간 미충족"
                    })
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const data = await response.json();
                    return { success: false, error: data.detail || '거부에 실패했습니다.' };
                }
            } catch (error) {
                return { success: false, error: '거부 처리에 실패했습니다.' };
            }
        }

        function updateActiveMembersFromAPI(members) {
            const container = document.getElementById('active-members-list');
            if (!container) {
                console.warn("❗ active-members-list 요소가 없습니다.");
                return;
            }

            container.innerHTML = "";

            if (!members || members.length === 0) {
                container.innerHTML = "<p>활성 멤버가 없습니다.</p>";
                return;
            }

            for (const member of members) {
                const div = document.createElement("div");
                div.className = "member-card";
                div.innerHTML = `
                    <div class="member-field"><span class="field-label">👤 이름:</span> ${member.name}</div>
                    <div class="member-field"><span class="field-label">📧 이메일:</span> ${member.email}</div>
                    <div class="member-field"><span class="field-label">🏷️ 직급:</span> ${member.role_name}</div>
                `;
                container.appendChild(div);
            }
        }

        async function kickWorkspaceMember(userId) {
            const workspaceName = localStorage.getItem("current_workspace_name");
            if (!workspaceName || !userId) {
                alert("유효하지 않은 요청입니다.");
                return;
            }

            if (!confirm("정말 이 멤버를 워크스페이스에서 추방하시겠습니까?")) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/workspaces/kick`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                    },
                    body: JSON.stringify({
                        workspace_name: workspaceName,
                        user_id: userId
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || "추방 실패");
                }

                const data = await res.json();
                alert(`✅ ${data.message}`);
                // 멤버 목록 다시 로드
                loadMembers(); // 또는 updateActiveMembersFromAPI(...) 호출
            } catch (error) {
                console.error("추방 에러:", error);
                //alert("❌ 추방에 실패했습니다: " + error.message);
            }
        }

        // 통계 실시간 업데이트
        function updateStatsAfterAction(action) {
            if (action === 'approve' || action === 'reject') {
                const pendingStatNumber = document.querySelectorAll('.stat-number')[1];
                const currentPending = parseInt(pendingStatNumber.textContent) - 1;
                pendingStatNumber.textContent = Math.max(0, currentPending);
                
                const pendingBadge = document.querySelector('#pending-tab .tab-badge');
                if (currentPending > 0 && pendingBadge) {
                    pendingBadge.textContent = currentPending;
                } else if (pendingBadge) {
                    pendingBadge.remove();
                }
                
                const workspaceMeta = document.querySelector('.workspace-meta');
                if (workspaceMeta) {
                    const totalMembers = parseInt(document.querySelectorAll('.stat-number')[0].textContent);
                    workspaceMeta.textContent = `총 ${totalMembers}명의 멤버 • ${Math.max(0, currentPending)}명 승인 대기 중`;
                }
                
                if (action === 'approve') {
                    const activeStatNumber = document.querySelectorAll('.stat-number')[2];
                    const currentActive = parseInt(activeStatNumber.textContent) + 1;
                    activeStatNumber.textContent = currentActive;
                    
                    const totalStatNumber = document.querySelectorAll('.stat-number')[0];
                    const currentTotal = parseInt(totalStatNumber.textContent) + 1;
                    totalStatNumber.textContent = currentTotal;
                    
                    const activeRate = ((currentActive / currentTotal) * 100).toFixed(1);
                    const activeChangeElement = document.querySelectorAll('.stat-change')[2];
                    activeChangeElement.textContent = `${activeRate}%`;
                    activeChangeElement.className = `stat-change ${activeRate > 80 ? 'positive' : 'neutral'}`;
                }
            }
        }

        // 에러 상태 표시
        function showErrorState() {
            const pendingList = document.getElementById('pending-list');
            pendingList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">⚠️</div>
                    <div class="empty-title">데이터를 불러올 수 없습니다</div>
                    <div class="empty-description">
                        서버 연결에 문제가 있습니다.<br>
                        <button class="btn btn-primary" onclick="loadInitialData()" style="margin-top: 12px;">
                            🔄 다시 시도
                        </button>
                    </div>
                </div>
            `;
            
            // 통계를 에러 상태로 설정
            const statNumbers = document.querySelectorAll('.stat-number');
            const statChanges = document.querySelectorAll('.stat-change');
            
            statNumbers.forEach(stat => stat.textContent = '오류');
            statChanges.forEach(change => {
                change.textContent = '연결 실패';
                change.className = 'stat-change neutral';
            });
            
            const workspaceMeta = document.querySelector('.workspace-meta');
            if (workspaceMeta) {
                workspaceMeta.textContent = '데이터 연결 실패 - 새로고침 후 다시 시도하세요';
            }
        }

        // 파견직 토글 설정
        function setupContractorToggle() {
            const contractorRadios = document.querySelectorAll('input[name="is_contractor"]');
            const expiresSection = document.getElementById('expires-section');
            
            contractorRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'true') {
                        expiresSection.style.display = 'block';
                        document.getElementById('expire-year').required = true;
                        document.getElementById('expire-month').required = true;
                        document.getElementById('expire-day').required = true;
                    } else {
                        expiresSection.style.display = 'none';
                        document.getElementById('expire-year').required = false;
                        document.getElementById('expire-month').required = false;
                        document.getElementById('expire-day').required = false;
                        document.getElementById('expire-year').value = '';
                        document.getElementById('expire-month').value = '';
                        document.getElementById('expire-day').value = '';
                    }
                });
            });
        }

        // 모달 외부 클릭 및 ESC 키 처리
        function setupModalClose() {
            document.getElementById('approval-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeApprovalModal();
                }
            });

            document.getElementById('confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeApprovalModal();
                    closeModal();
                }
            });
        }

        // 기타 기능들
        async function inviteMembers() {
            const workspaceName = localStorage.getItem("current_workspace_name");
            if (!workspaceName) {
                alert("워크스페이스 정보가 없습니다.");
                return;
            }

            try {
                const token = localStorage.getItem("access_token");

                const response = await fetch(`${API_BASE_URL}/auth/invite-codes-create`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        workspace_name: workspaceName
                        // expires_at 생략 가능 (백엔드에서 Optional 처리 시)
                    })
                });

                const data = await response.json();

                if (response.ok && data.code) {
                    const message = `🎉 초대 코드가 생성되었습니다!\n\n🔗 초대 코드: ${data.code}`;
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(data.code);
                        alert(`${message}\n\n📋 클립보드에 복사되었습니다.`);
                    } else {
                        alert(message);
                    }
                } else {
                    alert(`❌ 초대 코드 생성 실패: ${data.detail || "알 수 없는 오류"}`);
                }
            } catch (error) {
                console.error("초대 코드 생성 중 오류:", error);
                alert("❌ 초대 코드 생성 중 오류가 발생했습니다.");
            }
        }


        function exportMembers() {
            const inputId = prompt("추방할 사용자 ID를 입력하세요:");
            const userId = parseInt(inputId);
            if (isNaN(userId)) {
                alert("숫자 ID를 입력해주세요.");
                return;
            }

            kickWorkspaceMember(userId);
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('관리자 페이지 초기화 시작...');
            
            setupContractorToggle();
            setupModalClose();
            loadInitialData();
        });
    </script>
</body>
</html>