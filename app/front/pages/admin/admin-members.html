<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€ - íšŒì› ê´€ë¦¬</title>
    
    <!-- CSS íŒŒì¼ë“¤ ì„í¬íŠ¸ -->
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/admin-members.css">
    
</head>
<body>
    <!-- ë°°ê²½ ì¥ì‹ -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>

    <div class="admin-container">
        <!-- í—¤ë” -->
        <div class="header-section">
            <div class="admin-badge">ğŸ‘‘ ê´€ë¦¬ì</div>
            <div class="logo">ğŸŒŠ</div>
            <h1 class="welcome-text">ë©¤ë²„ ê´€ë¦¬</h1>
            <p class="subtitle">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë©¤ë²„ë“¤ì˜ ê°€ì… ìŠ¹ì¸ê³¼<br>ê¶Œí•œ ê´€ë¦¬ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”</p>
        </div>

        <!-- ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ -->
        <div class="workspace-info">
            <div class="workspace-icon">ğŸš€</div>
            <div class="workspace-details">
                <div class="workspace-name" id="workspace-name"></div>
                <div class="workspace-meta">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
        </div>

        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="stats-section">
            <div class="section-title">ğŸ“Š ë©¤ë²„ í˜„í™©</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">ğŸ‘¥</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">ì „ì²´ ë©¤ë²„</div>
                    <div class="stat-change neutral">ë¡œë”© ì¤‘</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">â³</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">ìŠ¹ì¸ ëŒ€ê¸°</div>
                    <div class="stat-change neutral">ë¡œë”© ì¤‘</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">âœ…</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">í™œì„± ë©¤ë²„</div>
                    <div class="stat-change neutral">ë¡œë”© ì¤‘</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">ğŸš«</div>
                    <div class="stat-number">-</div>
                    <div class="stat-label">ì •ì§€ëœ ë©¤ë²„</div>
                    <div class="stat-change neutral">ë¡œë”© ì¤‘</div>
                </div>
            </div>
        </div>

        <!-- íƒ­ ì„¹ì…˜ -->
        <div class="tab-section">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('pending')" id="pending-tab">
                    ìŠ¹ì¸ ëŒ€ê¸°
                </button>
                <button class="tab-button" onclick="switchTab('active')" id="active-tab">
                    í™œì„± ë©¤ë²„
                </button>
                <button class="tab-button" onclick="switchTab('suspended')" id="suspended-tab">
                    ì •ì§€ëœ ë©¤ë²„
                </button>
            </div>

            <!-- ìŠ¹ì¸ ëŒ€ê¸° íƒ­ -->
            <div class="tab-content active" id="pending-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="ì´ë¦„, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." id="pending-search">
                    <select class="filter-select" id="pending-filter">
                        <option value="all">ëª¨ë“  ìš”ì²­</option>
                        <option value="recent">ìµœê·¼ ìš”ì²­</option>
                        <option value="old">ì˜¤ë˜ëœ ìš”ì²­</option>
                    </select>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="inviteMembers()">
                            â• ë©¤ë²„ ì´ˆëŒ€
                        </button>
                    </div>
                </div>

                <div class="members-grid" id="pending-list">
                    <div class="loading-state">
                        <div class="loading-spinner-large"></div>
                        <div>ìŠ¹ì¸ ëŒ€ê¸° ë©¤ë²„ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
                    </div>
                </div>
            </div>

            <!-- í™œì„± ë©¤ë²„ íƒ­ -->
            <div class="tab-content" id="active-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="ì´ë¦„, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." id="active-search">
                    <select class="filter-select" id="active-filter">
                        <option value="all">ëª¨ë“  ë©¤ë²„</option>
                        <option value="admin">ê´€ë¦¬ì</option>
                        <option value="member">ì¼ë°˜ ë©¤ë²„</option>
                        <option value="contractor">íŒŒê²¬ì§</option>
                    </select>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="exportMembers()">
                            ğŸ“¤ ë‚´ë³´ë‚´ê¸°
                        </button>
                        <button class="btn btn-primary" onclick="inviteMembers()">
                            â• ë©¤ë²„ ì´ˆëŒ€
                        </button>
                    </div>
                </div>

                <div class="members-grid" id="active-members-list">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¥</div>
                        <div class="empty-title">í™œì„± ë©¤ë²„ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>
                        <div class="empty-description">ìŠ¹ì¸ëœ ë©¤ë²„ë“¤ì´ ì—¬ê¸°ì— ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <!-- ì •ì§€ëœ ë©¤ë²„ íƒ­ -->
            <div class="tab-content" id="suspended-content">
                <div class="empty-state">
                    <div class="empty-icon">ğŸš«</div>
                    <div class="empty-title">ì •ì§€ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-description">í˜„ì¬ ì •ì§€ëœ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>í•„ìš”ì‹œ ë©¤ë²„ ê´€ë¦¬ì—ì„œ ì •ì§€ ì¡°ì¹˜ë¥¼ ì·¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¹ì¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="approval-modal">
        <div class="modal approval-modal">
            <div class="modal-header">
                <div class="modal-icon">âœ…</div>
                <div class="modal-title">ë©¤ë²„ ìŠ¹ì¸</div>
                <div class="modal-description">ê°€ì… ìŠ¹ì¸ ë° ì„¤ì •ì„ ì§„í–‰í•©ë‹ˆë‹¤</div>
            </div>
            
            <!-- ì‹ ì²­ì ì •ë³´ -->
            <div class="applicant-info" id="applicant-info">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì´ë¦„:</strong> <span id="applicant-name">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì´ë©”ì¼:</strong> <span id="applicant-email">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì‹ ì²­ ì§ê¸‰:</strong> <span id="applicant-role">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì´ˆëŒ€ ì½”ë“œ:</strong> <span id="applicant-code">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ íŒŒê²¬ì§:</strong></span>
                    <div class="radio-group" style="margin: 0;">
                        <label style="margin-right: 8px;">
                            <input type="radio" name="is_contractor" value="false" checked>
                            No
                        </label>
                        <label>
                            <input type="radio" name="is_contractor" value="true">
                            Yes
                        </label>
                    </div>
                </div>
                <!-- ë§Œë£Œì¼ ì„¤ì • -->
                <div id="expires-section" style="display: none; margin-top: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span><strong>â€¢ ë§Œë£Œì¼:</strong></span>
                        <div class="date-inputs" style="margin: 0;">
                            <select id="expire-year" required style="min-width: 65px;">
                                <option value="">ë…„</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                            </select>
                            <span>ë…„</span>
                            
                            <select id="expire-month" required style="min-width: 50px;">
                                <option value="">ì›”</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                            <span>ì›”</span>
                            
                            <select id="expire-day" required style="min-width: 50px;">
                                <option value="">ì¼</option>
                                <option value="01">01</option>
                                <option value="02">02</option>
                                <option value="03">03</option>
                                <option value="04">04</option>
                                <option value="05">05</option>
                                <option value="06">06</option>
                                <option value="07">07</option>
                                <option value="08">08</option>
                                <option value="09">09</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                                <option value="13">13</option>
                                <option value="14">14</option>
                                <option value="15">15</option>
                                <option value="16">16</option>
                                <option value="17">17</option>
                                <option value="18">18</option>
                                <option value="19">19</option>
                                <option value="20">20</option>
                                <option value="21">21</option>
                                <option value="22">22</option>
                                <option value="23">23</option>
                                <option value="24">24</option>
                                <option value="25">25</option>
                                <option value="26">26</option>
                                <option value="27">27</option>
                                <option value="28">28</option>
                                <option value="29">29</option>
                                <option value="30">30</option>
                                <option value="31">31</option>
                            </select>
                            <span>ì¼</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ìµœì¢… ì§ê¸‰ ì„¤ì • -->
            <div class="form-group">
                <label class="form-label">
                    ìµœì¢… ì§ê¸‰ <span class="required">*</span>
                </label>
                <select class="role-select" id="final-role">
                    <option value="">ì§ê¸‰ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ì‚¬ì›">ì‚¬ì›</option>
                    <option value="ëŒ€ë¦¬">ëŒ€ë¦¬</option>
                    <option value="ê³¼ì¥">ê³¼ì¥</option>
                    <option value="íŒ€ì¥">íŒ€ì¥</option>
                    <option value="ë¶€ì¥">ë¶€ì¥</option>
                    <option value="ì´ì‚¬">ì´ì‚¬</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeApprovalModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="confirm-approval-btn" onclick="confirmApproval()">
                    <div class="loading-spinner" id="approval-spinner"></div>
                    <span id="approval-text">ìŠ¹ì¸í•˜ê¸°</span>
                </button>
            </div>
        </div>
    </div>

    <!-- í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modal-icon">âš ï¸</div>
                <div class="modal-title" id="modal-title">ì‘ì—… í™•ì¸</div>
                <div class="modal-description" id="modal-description">ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="confirm-btn" onclick="confirmAction()">
                    <div class="loading-spinner" id="modal-spinner"></div>
                    <span id="confirm-text">í™•ì¸</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        const API_BASE_URL = 'http://localhost:8000';
        let currentAction = null;
        let targetMember = null;
        let approvalMember = null;

        // APIì—ì„œ ë°›ì€ ì‹¤ì œ ë°ì´í„°ë¡œ í†µê³„ ì—…ë°ì´íŠ¸
        function updateStatisticsFromAPI(stats) {
            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë©”íƒ€ ì •ë³´ ì—…ë°ì´íŠ¸
            const workspaceMeta = document.querySelector('.workspace-meta');
            if (workspaceMeta) {
                workspaceMeta.textContent = `ì´ ${stats.totalMembers}ëª…ì˜ ë©¤ë²„ â€¢ ${stats.pendingCount}ëª… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`;
            }
            
            // í†µê³„ ì¹´ë“œë“¤ ì—…ë°ì´íŠ¸
            const statNumbers = document.querySelectorAll('.stat-number');
            const statChanges = document.querySelectorAll('.stat-change');
            
            if (statNumbers[0]) statNumbers[0].textContent = stats.totalMembers;
            if (statNumbers[1]) statNumbers[1].textContent = stats.pendingCount;
            if (statNumbers[2]) statNumbers[2].textContent = stats.activeMembers;
            if (statNumbers[3]) statNumbers[3].textContent = stats.suspendedMembers;
            
            // ë³€í™”ëŸ‰ ì—…ë°ì´íŠ¸
            if (statChanges[0]) {
                statChanges[0].textContent = stats.weeklyChange > 0 ? `+${stats.weeklyChange} ì´ë²ˆ ì£¼` : 'ë³€í™” ì—†ìŒ';
                statChanges[0].className = `stat-change ${stats.weeklyChange > 0 ? 'positive' : 'neutral'}`;
            }
            if (statChanges[1]) {
                statChanges[1].textContent = stats.pendingCount > 0 ? 'ìƒˆ ìš”ì²­' : 'ëŒ€ê¸° ì—†ìŒ';
                statChanges[1].className = 'stat-change neutral';
            }
            if (statChanges[2]) {
                const activeRate = stats.totalMembers > 0 ? ((stats.activeMembers / stats.totalMembers) * 100).toFixed(1) : 0;
                statChanges[2].textContent = `${activeRate}%`;
                statChanges[2].className = `stat-change ${activeRate > 80 ? 'positive' : 'neutral'}`;
            }
            if (statChanges[3]) {
                statChanges[3].textContent = 'ë³€í™” ì—†ìŒ';
                statChanges[3].className = 'stat-change neutral';
            }
            
            // ìŠ¹ì¸ ëŒ€ê¸° íƒ­ ë°°ì§€ ì—…ë°ì´íŠ¸
            const pendingTab = document.getElementById('pending-tab');
            const existingBadge = pendingTab.querySelector('.tab-badge');
            
            if (stats.pendingCount > 0) {
                if (!existingBadge) {
                    const badge = document.createElement('span');
                    badge.className = 'tab-badge';
                    badge.textContent = stats.pendingCount;
                    pendingTab.appendChild(badge);
                } else {
                    existingBadge.textContent = stats.pendingCount;
                }
            } else if (existingBadge) {
                existingBadge.remove();
            }
        }

        // APIì—ì„œ ë°›ì€ ìŠ¹ì¸ ëŒ€ê¸° ë©¤ë²„ë“¤ë¡œ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updatePendingMembersFromAPI(members) {
            const pendingList = document.getElementById('pending-list');
            
            if (members.length === 0) {
                pendingList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">â³</div>
                        <div class="empty-title">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-description">ìƒˆë¡œìš´ ê°€ì… ìš”ì²­ì´ ìˆìœ¼ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
                    </div>
                `;
                return;
            }
            
            pendingList.innerHTML = '';
            
            members.forEach(member => {
                const memberCard = createMemberCard(member);
                pendingList.appendChild(memberCard);
            });
        }

        // ë©¤ë²„ ì¹´ë“œ ìƒì„±
        function createMemberCard(member) {
            const card = document.createElement('div');
            card.className = 'member-card';
            card.setAttribute('data-member-id', member.request_id || member.id);
            
            const firstChar = member.user_name ? member.user_name.charAt(0) : member.name.charAt(0);
            const requestDate = new Date(member.requested_at || member.created_at).toLocaleDateString('ko-KR');
            
            card.innerHTML = `
                <div class="member-header">
                    <div class="member-avatar">${firstChar}</div>
                    <div class="member-info">
                        <div class="member-name">${member.user_name || member.name}</div>
                        <div class="member-email">${member.user_email || member.email}</div>
                        <div class="member-status">
                            <span class="status-badge status-pending">â³ ìŠ¹ì¸ ëŒ€ê¸°</span>
                        </div>
                    </div>
                </div>
                <div class="member-meta">
                    <div class="meta-row">
                        <span class="meta-label">ì‹ ì²­ ì§ê¸‰</span>
                        <span class="meta-value">ğŸ·ï¸ ${member.role_name || member.requested_role}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">ìš”ì²­ì¼</span>
                        <span class="meta-value">ğŸ“… ${requestDate}</span>
                    </div>
                    <div class="meta-row">
                        <span class="meta-label">íŒŒê²¬ì§</span>
                        <span class="meta-value">${member.is_contractor ? 'âœ… Yes' : 'âŒ No'}</span>
                    </div>
                </div>
                <div class="member-actions">
                    <button class="action-btn action-approve" onclick="approveMember(${member.request_id || member.id}, '${member.user_name || member.name}', '${member.user_email || member.email}', '${member.role_name || member.requested_role}')">
                        âœ… ìŠ¹ì¸
                    </button>
                    <button class="action-btn action-reject" onclick="rejectMember(${member.request_id || member.id}, '${member.user_name || member.name}')">
                        âŒ ê±°ë¶€
                    </button>
                </div>
            `;
            
            return card;
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ - ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •ë¨!
        async function loadInitialData() {
            try {
                console.log('ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
                
                const token = localStorage.getItem('access_token');
                const workspaceName = localStorage.getItem("current_workspace_name");
                if (workspaceName) {
                    document.getElementById("workspace-name").textContent = workspaceName;
                } else {
                    document.getElementById("workspace-name").textContent = "ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì´ë¦„ ì—†ìŒ";
                    console.warn("âš ï¸ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ current_workspace_nameì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
                const headers = {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                };
                
                // ê°€ì… ìš”ì²­ ëª©ë¡ ì¡°íšŒ (POST ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
                const pendingResponse = await fetch(`${API_BASE_URL}/workspaces/join-requests-list`, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        "workspace_name": workspaceName
                    })
                });
                
                // ë©¤ë²„ ëª©ë¡ ì¡°íšŒ (POST ë°©ì‹ìœ¼ë¡œ ë³€ê²½)
                const membersResponse = await fetch(`${API_BASE_URL}/workspaces/members`, {
                    method: 'POST', 
                    headers: headers,
                    body: JSON.stringify({
                        "workspace_name": workspaceName
                    })
                });
                
                const pendingData = await pendingResponse.json();
                const membersData = await membersResponse.json();
                console.log("âœ… membersData:", membersData);

                // ì—¬ê¸°ì„œ í˜¸ì¶œ!
                updateActiveMembersFromAPI(Array.isArray(membersData) ? membersData : []);
                
                // í†µê³„ ê³„ì‚°
                const stats = {
                    totalMembers: Array.isArray(membersData) ? membersData.length : 0,
                    pendingCount: Array.isArray(pendingData) ? pendingData.length : 0,
                    activeMembers: Array.isArray(membersData) ? membersData.length : 0,
                    suspendedMembers: 0,
                    weeklyChange: 0
                };
                
                updateStatisticsFromAPI(stats);
                updatePendingMembersFromAPI(Array.isArray(pendingData) ? pendingData : []);
                
                console.log('ì´ˆê¸° ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showErrorState();
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // ìŠ¹ì¸ ëª¨ë‹¬
        function approveMember(memberId, memberName, memberEmail, memberRole) {
            approvalMember = { 
                id: memberId, 
                name: memberName, 
                email: memberEmail, 
                role: memberRole
            };
            
            document.getElementById('applicant-name').textContent = memberName;
            document.getElementById('applicant-email').textContent = memberEmail;
            document.getElementById('applicant-role').textContent = memberRole;
            document.getElementById('applicant-code').textContent = '-';
            document.getElementById('final-role').value = memberRole;
            
            document.querySelector('input[name="is_contractor"][value="false"]').checked = true;
            document.getElementById('expires-section').style.display = 'none';
            
            document.getElementById('expire-year').value = '';
            document.getElementById('expire-month').value = '';
            document.getElementById('expire-day').value = '';
            
            document.getElementById('approval-modal').style.display = 'flex';
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').style.display = 'none';
            approvalMember = null;
        }

        // ìŠ¹ì¸ ì²˜ë¦¬ - ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •ë¨!
        async function confirmApproval() {
            if (!approvalMember) return;

            const finalRole = document.getElementById('final-role').value.trim();
            const isContractor = document.querySelector('input[name="is_contractor"]:checked').value === 'true';
            
            if (!finalRole) {
                alert('ìµœì¢… ì§ê¸‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì—¬ê¸°ì„œ ë¨¼ì € ì„ ì–¸í•´ì¤ë‹ˆë‹¤
            let year, month, day;
            let expiresAt = null;

            if (isContractor) {
                const year = document.getElementById('expire-year').value;
                const month = document.getElementById('expire-month').value;
                const day = document.getElementById('expire-day').value;
                
                if (!year || !month || !day) {
                    alert('íŒŒê²¬ ë§Œë£Œì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                
                expiresAt = `${year}-${month}-${day}T23:59:59`;
            }

            const confirmBtn = document.getElementById('confirm-approval-btn');
            const confirmText = document.getElementById('approval-text');
            const spinner = document.getElementById('approval-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...';
            spinner.style.display = 'inline-block';

            try {
                const approvalData = {
                    user_name: approvalMember.name,
                    role_name: finalRole,
                    is_contractor: isContractor,
                    expires_at: expiresAt
                };

                const result = await approveMemberAPI(approvalMember.id, approvalData);
                
                if (result.success) {
                    const contractorText = isContractor ? ` (íŒŒê²¬ì§, ~${year}.${month}.${day})` : ' (ì •ê·œì§)';
                    alert(`âœ… ${approvalMember.name}ë‹˜ì´ ${finalRole}${contractorText}ìœ¼ë¡œ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    
                    const memberCard = document.querySelector(`[data-member-id="${approvalMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            
                            const remainingCards = document.querySelectorAll('#pending-list .member-card');
                            if (remainingCards.length === 0) {
                                updatePendingMembersFromAPI([]);
                            }
                        }, 300);
                    }
                    
                    updateStatsAfterAction('approve');
                    closeApprovalModal();
                } else {
                    alert(`âŒ ìŠ¹ì¸ ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                //alert('âŒ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = 'ìŠ¹ì¸í•˜ê¸°';
                spinner.style.display = 'none';
            }
        }

        // ê±°ë¶€ ëª¨ë‹¬
        function rejectMember(memberId, memberName) {
            currentAction = 'reject';
            targetMember = { id: memberId, name: memberName };
            
            showModal(
                'âŒ',
                'ê°€ì… ê±°ë¶€',
                `${memberName}ë‹˜ì˜ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê°€ì… ìš”ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                'ê±°ë¶€í•˜ê¸°'
            );
        }

        function showModal(icon, title, description, confirmText) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-description').textContent = description;
            document.getElementById('confirm-text').textContent = confirmText;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            currentAction = null;
            targetMember = null;
        }

        async function confirmAction() {
            if (!currentAction || !targetMember) return;

            const confirmBtn = document.getElementById('confirm-btn');
            const confirmText = document.getElementById('confirm-text');
            const spinner = document.getElementById('modal-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = 'ì²˜ë¦¬ ì¤‘...';
            spinner.style.display = 'inline-block';

            try {
                let result;
                
                switch (currentAction) {
                    case 'reject':
                        result = await rejectMemberAPI(targetMember.id);
                        break;
                    default:
                        result = { success: false, error: 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì—…ì…ë‹ˆë‹¤.' };
                }

                if (result.success) {
                    alert(`âŒ ${targetMember.name}ë‹˜ì˜ ê°€ì… ìš”ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    
                    const memberCard = document.querySelector(`[data-member-id="${targetMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            
                            const remainingCards = document.querySelectorAll('#pending-list .member-card');
                            if (remainingCards.length === 0) {
                                updatePendingMembersFromAPI([]);
                            }
                        }, 300);
                    }
                    
                    updateStatsAfterAction('reject');
                    closeModal();
                } else {
                    alert(`âŒ ì˜¤ë¥˜: ${result.error}`);
                }
            } catch (error) {
                alert('âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = 'ê±°ë¶€í•˜ê¸°';
                spinner.style.display = 'none';
            }
        }

        // API í˜¸ì¶œ í•¨ìˆ˜ë“¤ - ì—”ë“œí¬ì¸íŠ¸ ìˆ˜ì •ë¨!
        async function approveMemberAPI(memberId, approvalData) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/workspaces/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "request_id": parseInt(memberId),
                        "user_name": approvalData.user_name,
                        "role_name": approvalData.role_name,
                        "is_contractor": approvalData.is_contractor,
                        "expires_at": approvalData.expires_at
                    })
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const data = await response.json();
                    return { success: false, error: data.detail || 'ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
                }
            } catch (error) {
                return { success: false, error: 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
            }
        }

        async function rejectMemberAPI(memberId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/workspaces/reject`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "request_id": parseInt(memberId),
                        "user_name": "ê¹€ìœ¤ìˆ˜",  // ì‹¤ì œ ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”
                        "reason": "ê¸°ì¤€ êµ¬ì„±ì› ìŠ¹ì¸ ê¸°ê°„ ë¯¸ì¶©ì¡±"
                    })
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const data = await response.json();
                    return { success: false, error: data.detail || 'ê±°ë¶€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
                }
            } catch (error) {
                return { success: false, error: 'ê±°ë¶€ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
            }
        }

        function updateActiveMembersFromAPI(members) {
            const container = document.getElementById('active-members-list');
            if (!container) {
                console.warn("â— active-members-list ìš”ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            container.innerHTML = "";

            if (!members || members.length === 0) {
                container.innerHTML = "<p>í™œì„± ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            for (const member of members) {
                const div = document.createElement("div");
                div.className = "member-card";
                div.innerHTML = `
                    <div class="member-field"><span class="field-label">ğŸ‘¤ ì´ë¦„:</span> ${member.name}</div>
                    <div class="member-field"><span class="field-label">ğŸ“§ ì´ë©”ì¼:</span> ${member.email}</div>
                    <div class="member-field"><span class="field-label">ğŸ·ï¸ ì§ê¸‰:</span> ${member.role_name}</div>
                `;
                container.appendChild(div);
            }
        }

        async function kickWorkspaceMember(userId) {
            const workspaceName = localStorage.getItem("current_workspace_name");
            if (!workspaceName || !userId) {
                alert("ìœ íš¨í•˜ì§€ ì•Šì€ ìš”ì²­ì…ë‹ˆë‹¤.");
                return;
            }

            if (!confirm("ì •ë§ ì´ ë©¤ë²„ë¥¼ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            try {
                const res = await fetch(`${API_BASE_URL}/workspaces/kick`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${localStorage.getItem("access_token")}`
                    },
                    body: JSON.stringify({
                        workspace_name: workspaceName,
                        user_id: userId
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || "ì¶”ë°© ì‹¤íŒ¨");
                }

                const data = await res.json();
                alert(`âœ… ${data.message}`);
                // ë©¤ë²„ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                loadMembers(); // ë˜ëŠ” updateActiveMembersFromAPI(...) í˜¸ì¶œ
            } catch (error) {
                console.error("ì¶”ë°© ì—ëŸ¬:", error);
                //alert("âŒ ì¶”ë°©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        }

        // í†µê³„ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateStatsAfterAction(action) {
            if (action === 'approve' || action === 'reject') {
                const pendingStatNumber = document.querySelectorAll('.stat-number')[1];
                const currentPending = parseInt(pendingStatNumber.textContent) - 1;
                pendingStatNumber.textContent = Math.max(0, currentPending);
                
                const pendingBadge = document.querySelector('#pending-tab .tab-badge');
                if (currentPending > 0 && pendingBadge) {
                    pendingBadge.textContent = currentPending;
                } else if (pendingBadge) {
                    pendingBadge.remove();
                }
                
                const workspaceMeta = document.querySelector('.workspace-meta');
                if (workspaceMeta) {
                    const totalMembers = parseInt(document.querySelectorAll('.stat-number')[0].textContent);
                    workspaceMeta.textContent = `ì´ ${totalMembers}ëª…ì˜ ë©¤ë²„ â€¢ ${Math.max(0, currentPending)}ëª… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘`;
                }
                
                if (action === 'approve') {
                    const activeStatNumber = document.querySelectorAll('.stat-number')[2];
                    const currentActive = parseInt(activeStatNumber.textContent) + 1;
                    activeStatNumber.textContent = currentActive;
                    
                    const totalStatNumber = document.querySelectorAll('.stat-number')[0];
                    const currentTotal = parseInt(totalStatNumber.textContent) + 1;
                    totalStatNumber.textContent = currentTotal;
                    
                    const activeRate = ((currentActive / currentTotal) * 100).toFixed(1);
                    const activeChangeElement = document.querySelectorAll('.stat-change')[2];
                    activeChangeElement.textContent = `${activeRate}%`;
                    activeChangeElement.className = `stat-change ${activeRate > 80 ? 'positive' : 'neutral'}`;
                }
            }
        }

        // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
        function showErrorState() {
            const pendingList = document.getElementById('pending-list');
            pendingList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">âš ï¸</div>
                    <div class="empty-title">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-description">
                        ì„œë²„ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.<br>
                        <button class="btn btn-primary" onclick="loadInitialData()" style="margin-top: 12px;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                </div>
            `;
            
            // í†µê³„ë¥¼ ì—ëŸ¬ ìƒíƒœë¡œ ì„¤ì •
            const statNumbers = document.querySelectorAll('.stat-number');
            const statChanges = document.querySelectorAll('.stat-change');
            
            statNumbers.forEach(stat => stat.textContent = 'ì˜¤ë¥˜');
            statChanges.forEach(change => {
                change.textContent = 'ì—°ê²° ì‹¤íŒ¨';
                change.className = 'stat-change neutral';
            });
            
            const workspaceMeta = document.querySelector('.workspace-meta');
            if (workspaceMeta) {
                workspaceMeta.textContent = 'ë°ì´í„° ì—°ê²° ì‹¤íŒ¨ - ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”';
            }
        }

        // íŒŒê²¬ì§ í† ê¸€ ì„¤ì •
        function setupContractorToggle() {
            const contractorRadios = document.querySelectorAll('input[name="is_contractor"]');
            const expiresSection = document.getElementById('expires-section');
            
            contractorRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'true') {
                        expiresSection.style.display = 'block';
                        document.getElementById('expire-year').required = true;
                        document.getElementById('expire-month').required = true;
                        document.getElementById('expire-day').required = true;
                    } else {
                        expiresSection.style.display = 'none';
                        document.getElementById('expire-year').required = false;
                        document.getElementById('expire-month').required = false;
                        document.getElementById('expire-day').required = false;
                        document.getElementById('expire-year').value = '';
                        document.getElementById('expire-month').value = '';
                        document.getElementById('expire-day').value = '';
                    }
                });
            });
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë° ESC í‚¤ ì²˜ë¦¬
        function setupModalClose() {
            document.getElementById('approval-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeApprovalModal();
                }
            });

            document.getElementById('confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeApprovalModal();
                    closeModal();
                }
            });
        }

        // ê¸°íƒ€ ê¸°ëŠ¥ë“¤
        async function inviteMembers() {
            const workspaceName = localStorage.getItem("current_workspace_name");
            if (!workspaceName) {
                alert("ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                const token = localStorage.getItem("access_token");

                const response = await fetch(`${API_BASE_URL}/auth/invite-codes-create`, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${token}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        workspace_name: workspaceName
                        // expires_at ìƒëµ ê°€ëŠ¥ (ë°±ì—”ë“œì—ì„œ Optional ì²˜ë¦¬ ì‹œ)
                    })
                });

                const data = await response.json();

                if (response.ok && data.code) {
                    const message = `ğŸ‰ ì´ˆëŒ€ ì½”ë“œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\nğŸ”— ì´ˆëŒ€ ì½”ë“œ: ${data.code}`;
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(data.code);
                        alert(`${message}\n\nğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    } else {
                        alert(message);
                    }
                } else {
                    alert(`âŒ ì´ˆëŒ€ ì½”ë“œ ìƒì„± ì‹¤íŒ¨: ${data.detail || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`);
                }
            } catch (error) {
                console.error("ì´ˆëŒ€ ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜:", error);
                alert("âŒ ì´ˆëŒ€ ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }


        function exportMembers() {
            const inputId = prompt("ì¶”ë°©í•  ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            const userId = parseInt(inputId);
            if (isNaN(userId)) {
                alert("ìˆ«ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            kickWorkspaceMember(userId);
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ê´€ë¦¬ì í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');
            
            setupContractorToggle();
            setupModalClose();
            loadInitialData();
        });
    </script>
</body>
</html>