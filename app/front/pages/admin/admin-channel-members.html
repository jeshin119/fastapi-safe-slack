<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì±„ë„ ë©¤ë²„ ê´€ë¦¬ - WorkSpace</title>
    
    <!-- CSS íŒŒì¼ë“¤ ì„í¬íŠ¸ -->
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/admin-channel-members.css">
    
</head>
<body>
    <!-- ë°°ê²½ ì¥ì‹ -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>

    <div class="admin-container">
        <!-- í—¤ë” -->
        <div class="header-section">
            <div class="admin-badge">ğŸ‘‘ ì±„ë„ ê´€ë¦¬ì</div>
            <div class="logo">ğŸŒŠ</div>
            <h1 class="welcome-text">ì±„ë„ ë©¤ë²„ ê´€ë¦¬</h1>
            <p class="subtitle">ì±„ë„ ë©¤ë²„ë“¤ì˜ ì…ì¥ ìš”ì²­ ìŠ¹ì¸ê³¼<br>ê¶Œí•œ ê´€ë¦¬ë¥¼ ìˆ˜í–‰í•˜ì„¸ìš”</p>
        </div>

        <!-- ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ -->
        <div class="workspace-info">
            <div class="workspace-icon">ğŸš€</div>
            <div class="workspace-details">
                <div class="workspace-name" id="workspace-name">ë¡œë”© ì¤‘...</div>
                <div class="workspace-meta" id="workspace-meta">ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
        </div>

        <!-- ì±„ë„ ì„ íƒ ì„¹ì…˜ -->
        <div class="stats-section">
            <div class="section-title">ğŸ·ï¸ ì±„ë„ ì„ íƒ</div>
            <div class="form-group">
                <select class="form-input" id="channel-select" onchange="loadChannelData()">
                    <option value="">ê´€ë¦¬í•  ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                </select>
            </div>
        </div>

        <!-- í†µê³„ ì„¹ì…˜ -->
        <div class="stats-section" id="stats-section" style="display: none;">
            <div class="section-title">ğŸ“Š ì±„ë„ ë©¤ë²„ í˜„í™©</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">ğŸ‘¥</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">ì „ì²´ ë©¤ë²„</div>
                    <div class="stat-change neutral">ë¡œë”© ì¤‘</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">â³</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">ì…ì¥ ëŒ€ê¸°</div>
                    <div class="stat-change neutral">ë¡œë”© ì¤‘</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">âœ…</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">í™œì„± ë©¤ë²„</div>
                    <div class="stat-change neutral">ë¡œë”© ì¤‘</div>
                </div>

                

                
            
        </div>

        <!-- íƒ­ ì„¹ì…˜ -->
        <div class="tab-section" id="tab-section" style="display: none;">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('pending')" id="pending-tab">
                    ì…ì¥ ìš”ì²­
                </button>
                <button class="tab-button" onclick="switchTab('active')" id="active-tab">
                    ì±„ë„ ë©¤ë²„
                </button>
            </div>

            <!-- ì…ì¥ ìš”ì²­ íƒ­ -->
            <div class="tab-content active" id="pending-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="ì´ë¦„, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." id="pending-search">
                </div>

                <div class="members-grid" id="pending-list">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“¢</div>
                        <div class="empty-title">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                        <div class="empty-description">ê´€ë¦¬í•  ì±„ë„ì„ ì„ íƒí•˜ë©´ ì…ì¥ ìš”ì²­ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <!-- í™œì„± ë©¤ë²„ íƒ­ -->
            <div class="tab-content" id="active-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="ì´ë¦„, ì´ë©”ì¼ë¡œ ê²€ìƒ‰..." id="active-search">
                    <select class="filter-select" id="active-filter">
                        <option value="all">ëª¨ë“  ë©¤ë²„</option>
                        <option value="admin">ê´€ë¦¬ì</option>
                        <option value="member">ì¼ë°˜ ë©¤ë²„</option>
                    </select>
                    
                </div>

                <div class="members-grid" id="active-members-list">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¥</div>
                        <div class="empty-title">ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”</div>
                        <div class="empty-description">ê´€ë¦¬í•  ì±„ë„ì„ ì„ íƒí•˜ë©´ ë©¤ë²„ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¹ì¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="approval-modal">
        <div class="modal approval-modal">
            <div class="modal-header">
                <div class="modal-icon">âœ…</div>
                <div class="modal-title">ì±„ë„ ì…ì¥ ìŠ¹ì¸</div>
                <div class="modal-description">ì±„ë„ ì…ì¥ ìš”ì²­ì„ ìŠ¹ì¸í•©ë‹ˆë‹¤</div>
            </div>
            
            <!-- ì‹ ì²­ì ì •ë³´ -->
            <div class="applicant-info" id="applicant-info">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì´ë¦„:</strong> <span id="applicant-name">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì´ë©”ì¼:</strong> <span id="applicant-email">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì§ê¸‰:</strong> <span id="applicant-role">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>â€¢ ì±„ë„:</strong> <span id="applicant-channel">-</span></span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeApprovalModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="confirm-approval-btn" onclick="confirmApproval()">
                    <div class="loading-spinner" id="approval-spinner"></div>
                    <span id="approval-text">ìŠ¹ì¸í•˜ê¸°</span>
                </button>
            </div>
        </div>
    </div>

    <!-- í™•ì¸ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modal-icon">âš ï¸</div>
                <div class="modal-title" id="modal-title">ì‘ì—… í™•ì¸</div>
                <div class="modal-description" id="modal-description">ì´ ì‘ì—…ì„ ìˆ˜í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="confirm-btn" onclick="confirmAction()">
                    <div class="loading-spinner" id="modal-spinner"></div>
                    <span id="confirm-text">í™•ì¸</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        const API_BASE_URL = 'http://localhost:8000';
        let currentWorkspace = null;
        let currentChannel = null;
        let currentAction = null;
        let targetMember = null;
        let approvalMember = null;

        // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ ë¡œë“œ
        async function loadWorkspaceInfo() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/workspaces/workspaces_list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const workspaces = await response.json();
                
                if (!workspaces || workspaces.length === 0) {
                    throw new Error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const workspace = workspaces[0];
                currentWorkspace = workspace.name;
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('workspace-name').textContent = workspace.name;
                document.getElementById('workspace-meta').textContent = `${workspace.member_count || 0}ëª…ì˜ ë©¤ë²„`;
                
                return workspace.name;
                
            } catch (error) {
                console.error('ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('workspace-name').textContent = 'ì—°ê²° ì‹¤íŒ¨';
                document.getElementById('workspace-meta').textContent = 'ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                return null;
            }
        }

        // ì±„ë„ ëª©ë¡ ë¡œë“œ
        async function loadChannels() {
            try {
                if (!currentWorkspace) return;
                
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace_name: currentWorkspace
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const channels = await response.json();
                
                const channelSelect = document.getElementById('channel-select');
                channelSelect.innerHTML = '<option value="">ê´€ë¦¬í•  ì±„ë„ì„ ì„ íƒí•˜ì„¸ìš”...</option>';
                
                if (Array.isArray(channels) && channels.length > 0) {
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = `${channel.is_public ? 'ğŸŒ' : 'ğŸ”’'} ${channel.name}`;
                        option.setAttribute('data-channel-id', channel.channel_id);
                        option.setAttribute('data-is-public', channel.is_public);
                        channelSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('ì±„ë„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                const channelSelect = document.getElementById('channel-select');
                channelSelect.innerHTML = '<option value="">ì±„ë„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</option>';
            }
        }

        // ì„ íƒëœ ì±„ë„ ë°ì´í„° ë¡œë“œ
        async function loadChannelData() {
            const channelSelect = document.getElementById('channel-select');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            
            if (!selectedOption.value) {
                hideChannelSections();
                return;
            }
            
            currentChannel = {
                name: selectedOption.value,
                id: selectedOption.getAttribute('data-channel-id'),
                isPublic: selectedOption.getAttribute('data-is-public') === 'true'
            };
            
            showChannelSections();
            await Promise.all([
                loadChannelMembers(),
                loadChannelRequests()
            ]);
        }

        // ì±„ë„ ì„¹ì…˜ í‘œì‹œ
        function showChannelSections() {
            document.getElementById('stats-section').style.display = 'block';
            document.getElementById('tab-section').style.display = 'block';
        }

        // ì±„ë„ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        function hideChannelSections() {
            document.getElementById('stats-section').style.display = 'none';
            document.getElementById('tab-section').style.display = 'none';
            currentChannel = null;
        }

        // ì±„ë„ ë©¤ë²„ ëª©ë¡ ë¡œë“œ
        async function loadChannelMembers() {
            try {
                if (!currentWorkspace || !currentChannel) return;
                
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/members_list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace_name: currentWorkspace,
                        channel_name: currentChannel.name
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const members = await response.json();
                updateChannelMembersList(Array.isArray(members) ? members : []);
                
            } catch (error) {
                console.error('ì±„ë„ ë©¤ë²„ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                showMembersError();
            }
        }

        // ì±„ë„ ì…ì¥ ìš”ì²­ ëª©ë¡ ë¡œë“œ
        async function loadChannelRequests() {
            try {
                if (!currentWorkspace || !currentChannel) return;
                
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/request_list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace_name: currentWorkspace
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const requests = await response.json();
                // í˜„ì¬ ì±„ë„ì— ëŒ€í•œ ìš”ì²­ë§Œ í•„í„°ë§
                const channelRequests = Array.isArray(requests) 
                    ? requests.filter(req => req.channel_name === currentChannel.name)
                    : [];
                    
                updateChannelRequestsList(channelRequests);
                
            } catch (error) {
                console.error('ì±„ë„ ì…ì¥ ìš”ì²­ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                showRequestsError();
            }
        }

        // ì±„ë„ ë©¤ë²„ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateChannelMembersList(members) {
            const container = document.getElementById('active-members-list');

            if (members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ‘¥</div>
                        <div class="empty-title">ì±„ë„ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-description">ì•„ì§ ì´ ì±„ë„ì— ê°€ì…í•œ ë©¤ë²„ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                `;
                updateChannelStats(0, 0);  // ë©¤ë²„ ìˆ˜: 0, ëŒ€ê¸° ìˆ˜: 0
                return;
            }

            container.innerHTML = '';

            members.forEach(member => {
                const memberCard = createMemberCard(member, 'active');
                container.appendChild(memberCard);
            });

            updateChannelStats(members.length, 0);  // ë©¤ë²„ ìˆ˜ ì—…ë°ì´íŠ¸, ëŒ€ê¸° ìˆ˜ëŠ” ì´ í•¨ìˆ˜ ë‚´ì—ì„œ ì•Œ ìˆ˜ ì—†ìŒ
        }

        // ì±„ë„ ì…ì¥ ìš”ì²­ ëª©ë¡ ì—…ë°ì´íŠ¸
        function updateChannelRequestsList(requests) {
            const container = document.getElementById('pending-list');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">â³</div>
                        <div class="empty-title">ì…ì¥ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-description">í˜„ì¬ ì´ ì±„ë„ì— ëŒ€í•œ ì…ì¥ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            requests.forEach(request => {
                const requestCard = createMemberCard(request, 'pending');
                container.appendChild(requestCard);
            });
            
            // í†µê³„ì— ìš”ì²­ ìˆ˜ ë°˜ì˜
            const currentMemberCount = document.querySelectorAll('#active-members-list .member-card').length;
            updateChannelStats(currentMemberCount, requests.length);
        }

        // ë©¤ë²„ ì¹´ë“œ ìƒì„±
        function createMemberCard(member, type) {
            const card = document.createElement('div');
            card.className = 'member-card';
            card.setAttribute('data-member-id', member.user_id || member.request_id);
            
            const name = member.name || member.user_name;
            const email = member.email || member.user_email;
            const role = member.role_name;
            const firstChar = name ? name.charAt(0) : '?';
            
            if (type === 'pending') {
                card.innerHTML = `
                    <div class="member-header">
                        <div class="member-avatar">${firstChar}</div>
                        <div class="member-info">
                            <div class="member-name">${name}</div>
                            <div class="member-email">${email}</div>
                            <div class="member-status">
                                <span class="status-badge status-pending">â³ ì…ì¥ ëŒ€ê¸°</span>
                            </div>
                        </div>
                    </div>
                    <div class="member-meta">
                        <div class="meta-row">
                            <span class="meta-label">ì§ê¸‰</span>
                            <span class="meta-value">ğŸ·ï¸ ${role}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">ì±„ë„</span>
                            <span class="meta-value">ğŸ“¢ ${member.channel_name}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">ìƒíƒœ</span>
                            <span class="meta-value">â³ ${member.status}</span>
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="action-btn action-approve" onclick="approveChannelEntry(${member.request_id}, '${name}', '${email}', '${role}')">
                            âœ… ìŠ¹ì¸
                        </button>
                        <button class="action-btn action-reject" onclick="rejectChannelEntry(${member.request_id}, '${name}')">
                            âŒ ê±°ë¶€
                        </button>
                    </div>
                `;
            } else {
                const isAdmin = member.is_admin ? 'ğŸ‘‘ ê´€ë¦¬ì' : 'ğŸ‘¤ ë©¤ë²„';
                card.innerHTML = `
                    <div class="member-header">
                        <div class="member-avatar">${firstChar}</div>
                        <div class="member-info">
                            <div class="member-name">${name}</div>
                            <div class="member-email">${email}</div>
                            <div class="member-status">
                                <span class="status-badge ${member.is_admin ? 'status-admin' : 'status-active'}">${isAdmin}</span>
                            </div>
                        </div>
                    </div>
                    <div class="member-meta">
                        <div class="meta-row">
                            <span class="meta-label">ì§ê¸‰</span>
                            <span class="meta-value">ğŸ·ï¸ ${role}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">ê¶Œí•œ</span>
                            <span class="meta-value">${member.is_admin ? 'ğŸ”‘ ê´€ë¦¬ì' : 'ğŸ‘¤ ì¼ë°˜ ë©¤ë²„'}</span>
                        </div>
                    </div>
    
                `;
            }

            return card;
        }

        // ì±„ë„ í†µê³„ ì—…ë°ì´íŠ¸
        function updateChannelStats(memberCount, pendingCount) {
            const statNumbers = document.querySelectorAll('.stat-number');
            const statChanges = document.querySelectorAll('.stat-change');

            console.log('statNumbers ê¸¸ì´:', statNumbers.length);
            console.log('statNumbers[1]:', statNumbers[1]); 
            if (statNumbers[1]) {
            console.log('pendingCount ì—…ë°ì´íŠ¸ ì „:', statNumbers[1].textContent);
            statNumbers[1].textContent = pendingCount;
            console.log('pendingCount ì—…ë°ì´íŠ¸ í›„:', statNumbers[1].textContent);
        }
            
            if (statNumbers[0]) statNumbers[0].textContent = memberCount;
            if (statNumbers[1]) statNumbers[1].textContent = pendingCount;
            if (statNumbers[2]) statNumbers[2].textContent = memberCount;
            
            
            if (statChanges[0]) {
                statChanges[0].textContent = `ì´ ${memberCount}ëª…`;
                statChanges[0].className = 'stat-change positive';
            }
            if (statChanges[1]) {
                statChanges[1].textContent = pendingCount > 0 ? 'ìƒˆ ìš”ì²­' : 'ëŒ€ê¸° ì—†ìŒ';
                statChanges[1].className = `stat-change ${pendingCount > 0 ? 'neutral' : 'positive'}`;
            }
            if (statChanges[2]) {
                statChanges[2].textContent = 'í™œì„± ìƒíƒœ';
                statChanges[2].className = 'stat-change positive';
            }
        
            
            // íƒ­ ë°°ì§€ ì—…ë°ì´íŠ¸
            const pendingTab = document.getElementById('pending-tab');
            const existingBadge = pendingTab.querySelector('.tab-badge');
            
            if (pendingCount > 0) {
                if (!existingBadge) {
                    const badge = document.createElement('span');
                    badge.className = 'tab-badge';
                    badge.textContent = pendingCount;
                    pendingTab.appendChild(badge);
                } else {
                    existingBadge.textContent = pendingCount;
                }
            } else if (existingBadge) {
                existingBadge.remove();
            }
        }

        // ì±„ë„ ì…ì¥ ìŠ¹ì¸
        function approveChannelEntry(requestId, memberName, memberEmail, memberRole) {
            approvalMember = { 
                id: requestId, 
                name: memberName, 
                email: memberEmail, 
                role: memberRole,
                channel: currentChannel.name
            };
            
            document.getElementById('applicant-name').textContent = memberName;
            document.getElementById('applicant-email').textContent = memberEmail;
            document.getElementById('applicant-role').textContent = memberRole;
            document.getElementById('applicant-channel').textContent = currentChannel.name;
            
            document.getElementById('approval-modal').style.display = 'flex';
        }

        // ìŠ¹ì¸ í™•ì¸
        async function confirmApproval() {
            if (!approvalMember || !currentWorkspace) return;

            const confirmBtn = document.getElementById('confirm-approval-btn');
            const confirmText = document.getElementById('approval-text');
            const spinner = document.getElementById('approval-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = 'ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘...';
            spinner.style.display = 'inline-block';

            try {
                const result = await approveChannelEntryAPI({
                    workspace_name: currentWorkspace,
                    request_id: approvalMember.id,
                    request_user_name: approvalMember.name,
                    request_role_name: approvalMember.role,
                    channel_name: approvalMember.channel
                });
                
                if (result.success) {
                    alert(`âœ… ${approvalMember.name}ë‹˜ì˜ "${approvalMember.channel}" ì±„ë„ ì…ì¥ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    
                    // ì¹´ë“œ ì œê±° ì• ë‹ˆë©”ì´ì…˜
                    const memberCard = document.querySelector(`[data-member-id="${approvalMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            checkEmptyPendingList();
                        }, 300);
                    }
                    
                    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    await Promise.all([
                        loadChannelMembers(),
                        loadChannelRequests()
                    ]);
                    
                    closeApprovalModal();
                } else {
                    alert(`âŒ ìŠ¹ì¸ ì‹¤íŒ¨: ${result.error}`);
                }
            } catch (error) {
                console.error('ìŠ¹ì¸ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('âŒ ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = 'ìŠ¹ì¸í•˜ê¸°';
                spinner.style.display = 'none';
            }
        }

        // ì±„ë„ ì…ì¥ ê±°ë¶€
        function rejectChannelEntry(requestId, memberName) {
            currentAction = 'reject';
            targetMember = { id: requestId, name: memberName };
            
            showModal(
                'âŒ',
                'ì…ì¥ ê±°ë¶€',
                `${memberName}ë‹˜ì˜ "${currentChannel.name}" ì±„ë„ ì…ì¥ ìš”ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                'ê±°ë¶€í•˜ê¸°'
            );
        }

        // ì±„ë„ì—ì„œ ì¶”ë°©
        function kickFromChannel(userId, memberName) {
            currentAction = 'kick';
            targetMember = { id: userId, name: memberName };
            
            showModal(
                'ğŸšª',
                'ì±„ë„ ì¶”ë°©',
                `${memberName}ë‹˜ì„ "${currentChannel.name}" ì±„ë„ì—ì„œ ì¶”ë°©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`,
                'ì¶”ë°©í•˜ê¸°'
            );
        }

        // API í˜¸ì¶œ í•¨ìˆ˜ë“¤
        async function approveChannelEntryAPI(data) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const errorData = await response.json();
                    return { success: false, error: errorData.detail || 'ìŠ¹ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
                }
            } catch (error) {
                return { success: false, error: 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
            }
        }

        // ëª¨ë‹¬ ê´€ë¦¬
        function showModal(icon, title, description, confirmText) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-description').textContent = description;
            document.getElementById('confirm-text').textContent = confirmText;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            currentAction = null;
            targetMember = null;
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').style.display = 'none';
            approvalMember = null;
        }

        // í™•ì¸ ì•¡ì…˜
        async function confirmAction() {
            if (!currentAction || !targetMember) return;

            const confirmBtn = document.getElementById('confirm-btn');
            const confirmText = document.getElementById('confirm-text');
            const spinner = document.getElementById('modal-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = 'ì²˜ë¦¬ ì¤‘...';
            spinner.style.display = 'inline-block';

            try {
                let result;
                
                switch (currentAction) {
                    case 'reject':
                        // ì±„ë„ ì…ì¥ ìš”ì²­ ê±°ë¶€ëŠ” ë³„ë„ APIê°€ ì—†ìœ¼ë¯€ë¡œ ì„ì‹œ ì²˜ë¦¬
                        result = { success: true };
                        break;
                    case 'kick':
                        result = await kickFromChannelAPI(targetMember.id);
                        break;
                    default:
                        result = { success: false, error: 'ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì—…ì…ë‹ˆë‹¤.' };
                }

                if (result.success) {
                    const actionText = currentAction === 'reject' ? 'ê±°ë¶€' : 'ì¶”ë°©';
                    alert(`âœ… ${targetMember.name}ë‹˜ì´ ${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    
                    // ì¹´ë“œ ì œê±° ì• ë‹ˆë©”ì´ì…˜
                    const memberCard = document.querySelector(`[data-member-id="${targetMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            if (currentAction === 'reject') {
                                checkEmptyPendingList();
                            } else {
                                checkEmptyMembersList();
                            }
                        }, 300);
                    }
                    
                    // ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                    if (currentAction === 'kick') {
                        await loadChannelMembers();
                    } else {
                        await loadChannelRequests();
                    }
                    
                    closeModal();
                } else {
                    alert(`âŒ ì˜¤ë¥˜: ${result.error}`);
                }
            } catch (error) {
                alert('âŒ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = currentAction === 'reject' ? 'ê±°ë¶€í•˜ê¸°' : 'ì¶”ë°©í•˜ê¸°';
                spinner.style.display = 'none';
            }
        }

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // ë¹ˆ ëª©ë¡ ì²´í¬
        function checkEmptyPendingList() {
            const remainingCards = document.querySelectorAll('#pending-list .member-card');
            if (remainingCards.length === 0) {
                updateChannelRequestsList([]);
            }
        }

        function checkEmptyMembersList() {
            const remainingCards = document.querySelectorAll('#active-members-list .member-card');
            if (remainingCards.length === 0) {
                updateChannelMembersList([]);
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showMembersError() {
            const container = document.getElementById('active-members-list');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">âš ï¸</div>
                    <div class="empty-title">ë©¤ë²„ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-description">
                        ì„œë²„ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.<br>
                        <button class="btn btn-primary" onclick="loadChannelMembers()" style="margin-top: 12px;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                </div>
            `;
        }

        function showRequestsError() {
            const container = document.getElementById('pending-list');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">âš ï¸</div>
                    <div class="empty-title">ìš”ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="empty-description">
                        ì„œë²„ ì—°ê²°ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤.<br>
                        <button class="btn btn-primary" onclick="loadChannelRequests()" style="margin-top: 12px;">
                            ğŸ”„ ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                </div>
            `;
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        function setupSearch() {
            const pendingSearch = document.getElementById('pending-search');
            const activeSearch = document.getElementById('active-search');
            
            if (pendingSearch) {
                pendingSearch.addEventListener('input', () => filterMembers('pending'));
            }
            
            if (activeSearch) {
                activeSearch.addEventListener('input', () => filterMembers('active'));
            }
        }

        function filterMembers(type) {
            const searchInput = document.getElementById(`${type}-search`);
            const searchTerm = searchInput.value.toLowerCase();
            const memberCards = document.querySelectorAll(`#${type === 'pending' ? 'pending-list' : 'active-members-list'} .member-card`);
            
            memberCards.forEach(card => {
                const name = card.querySelector('.member-name').textContent.toLowerCase();
                const email = card.querySelector('.member-email').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ë‚´ë³´ë‚´ê¸° (ë©¤ë²„ ê°•í‡´ ê¸°ëŠ¥ìœ¼ë¡œ ë³€ê²½)
        function exportMembers() {
            const inputId = prompt("ê°•í‡´í•  ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            const userId = parseInt(inputId);
            if (isNaN(userId)) {
                alert("ìˆ«ì IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }

            const memberCards = document.querySelectorAll('#active-members-list .member-card');
            let memberName = 'ì‚¬ìš©ì';
            
            // í•´ë‹¹ IDì˜ ë©¤ë²„ ì´ë¦„ ì°¾ê¸°
            memberCards.forEach(card => {
                if (card.getAttribute('data-member-id') == userId) {
                    memberName = card.querySelector('.member-name').textContent;
                }
            });

            kickFromChannel(userId, memberName);
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë° ESC í‚¤ ì²˜ë¦¬
        function setupModalClose() {
            document.getElementById('approval-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeApprovalModal();
                }
            });

            document.getElementById('confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeApprovalModal();
                    closeModal();
                }
            });
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ì±„ë„ ë©¤ë²„ ê´€ë¦¬ í˜ì´ì§€ ì´ˆê¸°í™” ì‹œì‘...');
            
            setupSearch();
            setupModalClose();
            
            // ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì •ë³´ ë¡œë“œ í›„ ì±„ë„ ëª©ë¡ ë¡œë“œ
            const workspaceName = await loadWorkspaceInfo();
            if (workspaceName) {
                await loadChannels();
            }
        });

        document.head.appendChild(style);
    </script>
</body>
</html>