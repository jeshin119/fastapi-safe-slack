<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>채널 멤버 관리 - WorkSpace</title>
    
    <!-- CSS 파일들 임포트 -->
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/admin-channel-members.css">
    
</head>
<body>
    <!-- 배경 장식 -->
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>
    <div class="bg-decoration"></div>

    <div class="admin-container">
        <!-- 헤더 -->
        <div class="header-section">
            <div class="admin-badge">👑 채널 관리자</div>
            <div class="logo">🌊</div>
            <h1 class="welcome-text">채널 멤버 관리</h1>
            <p class="subtitle">채널 멤버들의 입장 요청 승인과<br>권한 관리를 수행하세요</p>
        </div>

        <!-- 워크스페이스 정보 -->
        <div class="workspace-info">
            <div class="workspace-icon">🚀</div>
            <div class="workspace-details">
                <div class="workspace-name" id="workspace-name">로딩 중...</div>
                <div class="workspace-meta" id="workspace-meta">워크스페이스 정보를 불러오고 있습니다...</div>
            </div>
        </div>

        <!-- 채널 선택 섹션 -->
        <div class="stats-section">
            <div class="section-title">🏷️ 채널 선택</div>
            <div class="form-group">
                <select class="form-input" id="channel-select" onchange="loadChannelData()">
                    <option value="">관리할 채널을 선택하세요...</option>
                </select>
            </div>
        </div>

        <!-- 통계 섹션 -->
        <div class="stats-section" id="stats-section" style="display: none;">
            <div class="section-title">📊 채널 멤버 현황</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #0ea5e9, #2563eb);">👥</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">전체 멤버</div>
                    <div class="stat-change neutral">로딩 중</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">⏳</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">입장 대기</div>
                    <div class="stat-change neutral">로딩 중</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #10b981, #059669);">✅</div>
                    <div class="stat-number">0</div>
                    <div class="stat-label">활성 멤버</div>
                    <div class="stat-change neutral">로딩 중</div>
                </div>

                

                
            
        </div>

        <!-- 탭 섹션 -->
        <div class="tab-section" id="tab-section" style="display: none;">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('pending')" id="pending-tab">
                    입장 요청
                </button>
                <button class="tab-button" onclick="switchTab('active')" id="active-tab">
                    채널 멤버
                </button>
            </div>

            <!-- 입장 요청 탭 -->
            <div class="tab-content active" id="pending-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="이름, 이메일로 검색..." id="pending-search">
                </div>

                <div class="members-grid" id="pending-list">
                    <div class="empty-state">
                        <div class="empty-icon">📢</div>
                        <div class="empty-title">채널을 선택하세요</div>
                        <div class="empty-description">관리할 채널을 선택하면 입장 요청 목록이 표시됩니다.</div>
                    </div>
                </div>
            </div>

            <!-- 활성 멤버 탭 -->
            <div class="tab-content" id="active-content">
                <div class="content-header">
                    <input type="text" class="search-input" placeholder="이름, 이메일로 검색..." id="active-search">
                    <select class="filter-select" id="active-filter">
                        <option value="all">모든 멤버</option>
                        <option value="admin">관리자</option>
                        <option value="member">일반 멤버</option>
                    </select>
                    
                </div>

                <div class="members-grid" id="active-members-list">
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <div class="empty-title">채널을 선택하세요</div>
                        <div class="empty-description">관리할 채널을 선택하면 멤버 목록이 표시됩니다.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 승인 모달 -->
    <div class="modal-overlay" id="approval-modal">
        <div class="modal approval-modal">
            <div class="modal-header">
                <div class="modal-icon">✅</div>
                <div class="modal-title">채널 입장 승인</div>
                <div class="modal-description">채널 입장 요청을 승인합니다</div>
            </div>
            
            <!-- 신청자 정보 -->
            <div class="applicant-info" id="applicant-info">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 이름:</strong> <span id="applicant-name">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 이메일:</strong> <span id="applicant-email">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 직급:</strong> <span id="applicant-role">-</span></span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span><strong>• 채널:</strong> <span id="applicant-channel">-</span></span>
                </div>
            </div>

            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeApprovalModal()">취소</button>
                <button class="btn btn-primary" id="confirm-approval-btn" onclick="confirmApproval()">
                    <div class="loading-spinner" id="approval-spinner"></div>
                    <span id="approval-text">승인하기</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 확인 모달 -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon" id="modal-icon">⚠️</div>
                <div class="modal-title" id="modal-title">작업 확인</div>
                <div class="modal-description" id="modal-description">이 작업을 수행하시겠습니까?</div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">취소</button>
                <button class="btn btn-primary" id="confirm-btn" onclick="confirmAction()">
                    <div class="loading-spinner" id="modal-spinner"></div>
                    <span id="confirm-text">확인</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        const API_BASE_URL = 'http://localhost:8000';
        let currentWorkspace = null;
        let currentChannel = null;
        let currentAction = null;
        let targetMember = null;
        let approvalMember = null;

        // 워크스페이스 정보 로드
        async function loadWorkspaceInfo() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/workspaces/workspaces_list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const workspaces = await response.json();
                
                if (!workspaces || workspaces.length === 0) {
                    throw new Error('워크스페이스가 없습니다.');
                }
                
                const workspace = workspaces[0];
                currentWorkspace = workspace.name;
                
                // UI 업데이트
                document.getElementById('workspace-name').textContent = workspace.name;
                document.getElementById('workspace-meta').textContent = `${workspace.member_count || 0}명의 멤버`;
                
                return workspace.name;
                
            } catch (error) {
                console.error('워크스페이스 정보 로드 실패:', error);
                document.getElementById('workspace-name').textContent = '연결 실패';
                document.getElementById('workspace-meta').textContent = '워크스페이스 정보를 불러올 수 없습니다';
                return null;
            }
        }

        // 채널 목록 로드
        async function loadChannels() {
            try {
                if (!currentWorkspace) return;
                
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace_name: currentWorkspace
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const channels = await response.json();
                
                const channelSelect = document.getElementById('channel-select');
                channelSelect.innerHTML = '<option value="">관리할 채널을 선택하세요...</option>';
                
                if (Array.isArray(channels) && channels.length > 0) {
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = `${channel.is_public ? '🌍' : '🔒'} ${channel.name}`;
                        option.setAttribute('data-channel-id', channel.channel_id);
                        option.setAttribute('data-is-public', channel.is_public);
                        channelSelect.appendChild(option);
                    });
                }
                
            } catch (error) {
                console.error('채널 목록 로드 실패:', error);
                const channelSelect = document.getElementById('channel-select');
                channelSelect.innerHTML = '<option value="">채널 목록을 불러올 수 없습니다</option>';
            }
        }

        // 선택된 채널 데이터 로드
        async function loadChannelData() {
            const channelSelect = document.getElementById('channel-select');
            const selectedOption = channelSelect.options[channelSelect.selectedIndex];
            
            if (!selectedOption.value) {
                hideChannelSections();
                return;
            }
            
            currentChannel = {
                name: selectedOption.value,
                id: selectedOption.getAttribute('data-channel-id'),
                isPublic: selectedOption.getAttribute('data-is-public') === 'true'
            };
            
            showChannelSections();
            await Promise.all([
                loadChannelMembers(),
                loadChannelRequests()
            ]);
        }

        // 채널 섹션 표시
        function showChannelSections() {
            document.getElementById('stats-section').style.display = 'block';
            document.getElementById('tab-section').style.display = 'block';
        }

        // 채널 섹션 숨기기
        function hideChannelSections() {
            document.getElementById('stats-section').style.display = 'none';
            document.getElementById('tab-section').style.display = 'none';
            currentChannel = null;
        }

        // 채널 멤버 목록 로드
        async function loadChannelMembers() {
            try {
                if (!currentWorkspace || !currentChannel) return;
                
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/members_list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace_name: currentWorkspace,
                        channel_name: currentChannel.name
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const members = await response.json();
                updateChannelMembersList(Array.isArray(members) ? members : []);
                
            } catch (error) {
                console.error('채널 멤버 목록 로드 실패:', error);
                showMembersError();
            }
        }

        // 채널 입장 요청 목록 로드
        async function loadChannelRequests() {
            try {
                if (!currentWorkspace || !currentChannel) return;
                
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/request_list`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        workspace_name: currentWorkspace
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const requests = await response.json();
                // 현재 채널에 대한 요청만 필터링
                const channelRequests = Array.isArray(requests) 
                    ? requests.filter(req => req.channel_name === currentChannel.name)
                    : [];
                    
                updateChannelRequestsList(channelRequests);
                
            } catch (error) {
                console.error('채널 입장 요청 목록 로드 실패:', error);
                showRequestsError();
            }
        }

        // 채널 멤버 목록 업데이트
        function updateChannelMembersList(members) {
            const container = document.getElementById('active-members-list');

            if (members.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">👥</div>
                        <div class="empty-title">채널 멤버가 없습니다</div>
                        <div class="empty-description">아직 이 채널에 가입한 멤버가 없습니다.</div>
                    </div>
                `;
                updateChannelStats(0, 0);  // 멤버 수: 0, 대기 수: 0
                return;
            }

            container.innerHTML = '';

            members.forEach(member => {
                const memberCard = createMemberCard(member, 'active');
                container.appendChild(memberCard);
            });

            updateChannelStats(members.length, 0);  // 멤버 수 업데이트, 대기 수는 이 함수 내에서 알 수 없음
        }

        // 채널 입장 요청 목록 업데이트
        function updateChannelRequestsList(requests) {
            const container = document.getElementById('pending-list');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">⏳</div>
                        <div class="empty-title">입장 요청이 없습니다</div>
                        <div class="empty-description">현재 이 채널에 대한 입장 요청이 없습니다.</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            requests.forEach(request => {
                const requestCard = createMemberCard(request, 'pending');
                container.appendChild(requestCard);
            });
            
            // 통계에 요청 수 반영
            const currentMemberCount = document.querySelectorAll('#active-members-list .member-card').length;
            updateChannelStats(currentMemberCount, requests.length);
        }

        // 멤버 카드 생성
        function createMemberCard(member, type) {
            const card = document.createElement('div');
            card.className = 'member-card';
            card.setAttribute('data-member-id', member.user_id || member.request_id);
            
            const name = member.name || member.user_name;
            const email = member.email || member.user_email;
            const role = member.role_name;
            const firstChar = name ? name.charAt(0) : '?';
            
            if (type === 'pending') {
                card.innerHTML = `
                    <div class="member-header">
                        <div class="member-avatar">${firstChar}</div>
                        <div class="member-info">
                            <div class="member-name">${name}</div>
                            <div class="member-email">${email}</div>
                            <div class="member-status">
                                <span class="status-badge status-pending">⏳ 입장 대기</span>
                            </div>
                        </div>
                    </div>
                    <div class="member-meta">
                        <div class="meta-row">
                            <span class="meta-label">직급</span>
                            <span class="meta-value">🏷️ ${role}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">채널</span>
                            <span class="meta-value">📢 ${member.channel_name}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">상태</span>
                            <span class="meta-value">⏳ ${member.status}</span>
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="action-btn action-approve" onclick="approveChannelEntry(${member.request_id}, '${name}', '${email}', '${role}')">
                            ✅ 승인
                        </button>
                        <button class="action-btn action-reject" onclick="rejectChannelEntry(${member.request_id}, '${name}')">
                            ❌ 거부
                        </button>
                    </div>
                `;
            } else {
                const isAdmin = member.is_admin ? '👑 관리자' : '👤 멤버';
                card.innerHTML = `
                    <div class="member-header">
                        <div class="member-avatar">${firstChar}</div>
                        <div class="member-info">
                            <div class="member-name">${name}</div>
                            <div class="member-email">${email}</div>
                            <div class="member-status">
                                <span class="status-badge ${member.is_admin ? 'status-admin' : 'status-active'}">${isAdmin}</span>
                            </div>
                        </div>
                    </div>
                    <div class="member-meta">
                        <div class="meta-row">
                            <span class="meta-label">직급</span>
                            <span class="meta-value">🏷️ ${role}</span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">권한</span>
                            <span class="meta-value">${member.is_admin ? '🔑 관리자' : '👤 일반 멤버'}</span>
                        </div>
                    </div>
    
                `;
            }

            return card;
        }

        // 채널 통계 업데이트
        function updateChannelStats(memberCount, pendingCount) {
            const statNumbers = document.querySelectorAll('.stat-number');
            const statChanges = document.querySelectorAll('.stat-change');

            console.log('statNumbers 길이:', statNumbers.length);
            console.log('statNumbers[1]:', statNumbers[1]); 
            if (statNumbers[1]) {
            console.log('pendingCount 업데이트 전:', statNumbers[1].textContent);
            statNumbers[1].textContent = pendingCount;
            console.log('pendingCount 업데이트 후:', statNumbers[1].textContent);
        }
            
            if (statNumbers[0]) statNumbers[0].textContent = memberCount;
            if (statNumbers[1]) statNumbers[1].textContent = pendingCount;
            if (statNumbers[2]) statNumbers[2].textContent = memberCount;
            
            
            if (statChanges[0]) {
                statChanges[0].textContent = `총 ${memberCount}명`;
                statChanges[0].className = 'stat-change positive';
            }
            if (statChanges[1]) {
                statChanges[1].textContent = pendingCount > 0 ? '새 요청' : '대기 없음';
                statChanges[1].className = `stat-change ${pendingCount > 0 ? 'neutral' : 'positive'}`;
            }
            if (statChanges[2]) {
                statChanges[2].textContent = '활성 상태';
                statChanges[2].className = 'stat-change positive';
            }
        
            
            // 탭 배지 업데이트
            const pendingTab = document.getElementById('pending-tab');
            const existingBadge = pendingTab.querySelector('.tab-badge');
            
            if (pendingCount > 0) {
                if (!existingBadge) {
                    const badge = document.createElement('span');
                    badge.className = 'tab-badge';
                    badge.textContent = pendingCount;
                    pendingTab.appendChild(badge);
                } else {
                    existingBadge.textContent = pendingCount;
                }
            } else if (existingBadge) {
                existingBadge.remove();
            }
        }

        // 채널 입장 승인
        function approveChannelEntry(requestId, memberName, memberEmail, memberRole) {
            approvalMember = { 
                id: requestId, 
                name: memberName, 
                email: memberEmail, 
                role: memberRole,
                channel: currentChannel.name
            };
            
            document.getElementById('applicant-name').textContent = memberName;
            document.getElementById('applicant-email').textContent = memberEmail;
            document.getElementById('applicant-role').textContent = memberRole;
            document.getElementById('applicant-channel').textContent = currentChannel.name;
            
            document.getElementById('approval-modal').style.display = 'flex';
        }

        // 승인 확인
        async function confirmApproval() {
            if (!approvalMember || !currentWorkspace) return;

            const confirmBtn = document.getElementById('confirm-approval-btn');
            const confirmText = document.getElementById('approval-text');
            const spinner = document.getElementById('approval-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = '승인 처리 중...';
            spinner.style.display = 'inline-block';

            try {
                const result = await approveChannelEntryAPI({
                    workspace_name: currentWorkspace,
                    request_id: approvalMember.id,
                    request_user_name: approvalMember.name,
                    request_role_name: approvalMember.role,
                    channel_name: approvalMember.channel
                });
                
                if (result.success) {
                    alert(`✅ ${approvalMember.name}님의 "${approvalMember.channel}" 채널 입장이 승인되었습니다!`);
                    
                    // 카드 제거 애니메이션
                    const memberCard = document.querySelector(`[data-member-id="${approvalMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            checkEmptyPendingList();
                        }, 300);
                    }
                    
                    // 데이터 새로고침
                    await Promise.all([
                        loadChannelMembers(),
                        loadChannelRequests()
                    ]);
                    
                    closeApprovalModal();
                } else {
                    alert(`❌ 승인 실패: ${result.error}`);
                }
            } catch (error) {
                console.error('승인 처리 오류:', error);
                alert('❌ 승인 처리 중 오류가 발생했습니다.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = '승인하기';
                spinner.style.display = 'none';
            }
        }

        // 채널 입장 거부
        function rejectChannelEntry(requestId, memberName) {
            currentAction = 'reject';
            targetMember = { id: requestId, name: memberName };
            
            showModal(
                '❌',
                '입장 거부',
                `${memberName}님의 "${currentChannel.name}" 채널 입장 요청을 거부하시겠습니까?`,
                '거부하기'
            );
        }

        // 채널에서 추방
        function kickFromChannel(userId, memberName) {
            currentAction = 'kick';
            targetMember = { id: userId, name: memberName };
            
            showModal(
                '🚪',
                '채널 추방',
                `${memberName}님을 "${currentChannel.name}" 채널에서 추방하시겠습니까?\n이 작업은 되돌릴 수 없습니다.`,
                '추방하기'
            );
        }

        // API 호출 함수들
        async function approveChannelEntryAPI(data) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE_URL}/channels/approve`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    return { success: true };
                } else {
                    const errorData = await response.json();
                    return { success: false, error: errorData.detail || '승인에 실패했습니다.' };
                }
            } catch (error) {
                return { success: false, error: '서버 연결에 실패했습니다.' };
            }
        }

        // 모달 관리
        function showModal(icon, title, description, confirmText) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-description').textContent = description;
            document.getElementById('confirm-text').textContent = confirmText;
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            currentAction = null;
            targetMember = null;
        }

        function closeApprovalModal() {
            document.getElementById('approval-modal').style.display = 'none';
            approvalMember = null;
        }

        // 확인 액션
        async function confirmAction() {
            if (!currentAction || !targetMember) return;

            const confirmBtn = document.getElementById('confirm-btn');
            const confirmText = document.getElementById('confirm-text');
            const spinner = document.getElementById('modal-spinner');

            confirmBtn.disabled = true;
            confirmText.textContent = '처리 중...';
            spinner.style.display = 'inline-block';

            try {
                let result;
                
                switch (currentAction) {
                    case 'reject':
                        // 채널 입장 요청 거부는 별도 API가 없으므로 임시 처리
                        result = { success: true };
                        break;
                    case 'kick':
                        result = await kickFromChannelAPI(targetMember.id);
                        break;
                    default:
                        result = { success: false, error: '알 수 없는 작업입니다.' };
                }

                if (result.success) {
                    const actionText = currentAction === 'reject' ? '거부' : '추방';
                    alert(`✅ ${targetMember.name}님이 ${actionText}되었습니다.`);
                    
                    // 카드 제거 애니메이션
                    const memberCard = document.querySelector(`[data-member-id="${targetMember.id}"]`);
                    if (memberCard) {
                        memberCard.style.animation = 'fadeOut 0.3s ease-out forwards';
                        setTimeout(() => {
                            memberCard.remove();
                            if (currentAction === 'reject') {
                                checkEmptyPendingList();
                            } else {
                                checkEmptyMembersList();
                            }
                        }, 300);
                    }
                    
                    // 데이터 새로고침
                    if (currentAction === 'kick') {
                        await loadChannelMembers();
                    } else {
                        await loadChannelRequests();
                    }
                    
                    closeModal();
                } else {
                    alert(`❌ 오류: ${result.error}`);
                }
            } catch (error) {
                alert('❌ 처리 중 오류가 발생했습니다.');
            } finally {
                confirmBtn.disabled = false;
                confirmText.textContent = currentAction === 'reject' ? '거부하기' : '추방하기';
                spinner.style.display = 'none';
            }
        }

        // 탭 전환
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-content`).classList.add('active');
        }

        // 빈 목록 체크
        function checkEmptyPendingList() {
            const remainingCards = document.querySelectorAll('#pending-list .member-card');
            if (remainingCards.length === 0) {
                updateChannelRequestsList([]);
            }
        }

        function checkEmptyMembersList() {
            const remainingCards = document.querySelectorAll('#active-members-list .member-card');
            if (remainingCards.length === 0) {
                updateChannelMembersList([]);
            }
        }

        // 에러 표시
        function showMembersError() {
            const container = document.getElementById('active-members-list');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">⚠️</div>
                    <div class="empty-title">멤버 목록을 불러올 수 없습니다</div>
                    <div class="empty-description">
                        서버 연결에 문제가 있습니다.<br>
                        <button class="btn btn-primary" onclick="loadChannelMembers()" style="margin-top: 12px;">
                            🔄 다시 시도
                        </button>
                    </div>
                </div>
            `;
        }

        function showRequestsError() {
            const container = document.getElementById('pending-list');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">⚠️</div>
                    <div class="empty-title">요청 목록을 불러올 수 없습니다</div>
                    <div class="empty-description">
                        서버 연결에 문제가 있습니다.<br>
                        <button class="btn btn-primary" onclick="loadChannelRequests()" style="margin-top: 12px;">
                            🔄 다시 시도
                        </button>
                    </div>
                </div>
            `;
        }

        // 검색 기능
        function setupSearch() {
            const pendingSearch = document.getElementById('pending-search');
            const activeSearch = document.getElementById('active-search');
            
            if (pendingSearch) {
                pendingSearch.addEventListener('input', () => filterMembers('pending'));
            }
            
            if (activeSearch) {
                activeSearch.addEventListener('input', () => filterMembers('active'));
            }
        }

        function filterMembers(type) {
            const searchInput = document.getElementById(`${type}-search`);
            const searchTerm = searchInput.value.toLowerCase();
            const memberCards = document.querySelectorAll(`#${type === 'pending' ? 'pending-list' : 'active-members-list'} .member-card`);
            
            memberCards.forEach(card => {
                const name = card.querySelector('.member-name').textContent.toLowerCase();
                const email = card.querySelector('.member-email').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || email.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // 내보내기 (멤버 강퇴 기능으로 변경)
        function exportMembers() {
            const inputId = prompt("강퇴할 사용자 ID를 입력하세요:");
            const userId = parseInt(inputId);
            if (isNaN(userId)) {
                alert("숫자 ID를 입력해주세요.");
                return;
            }

            const memberCards = document.querySelectorAll('#active-members-list .member-card');
            let memberName = '사용자';
            
            // 해당 ID의 멤버 이름 찾기
            memberCards.forEach(card => {
                if (card.getAttribute('data-member-id') == userId) {
                    memberName = card.querySelector('.member-name').textContent;
                }
            });

            kickFromChannel(userId, memberName);
        }

        // 모달 외부 클릭 및 ESC 키 처리
        function setupModalClose() {
            document.getElementById('approval-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeApprovalModal();
                }
            });

            document.getElementById('confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeApprovalModal();
                    closeModal();
                }
            });
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('채널 멤버 관리 페이지 초기화 시작...');
            
            setupSearch();
            setupModalClose();
            
            // 워크스페이스 정보 로드 후 채널 목록 로드
            const workspaceName = await loadWorkspaceInfo();
            if (workspaceName) {
                await loadChannels();
            }
        });

        document.head.appendChild(style);
    </script>
</body>
</html>